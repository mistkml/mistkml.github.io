

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Guide &mdash; MISTK  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Getting Started" href="intro.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> MISTK
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#model-interface">Model Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-model-state-machine">The Model State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-a-model">Initializing a Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hyperparameters">Hyperparameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-properties">Model Properties</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-data">Loading Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-status">Model Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#predictions-and-ground-truth">Predictions and Ground Truth</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-model">Example Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transfer-learning">Transfer learning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#data-transformation-interface">Data Transformation Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-transformation-state-machine">The Transformation State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#evaluation-interface">Evaluation Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#evaluation-metrics">Evaluation Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-evaluation-state-machine">The Evaluation State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">MISTK API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MISTK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="guide">
<h1>Guide<a class="headerlink" href="#guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="model-interface">
<h2>Model Interface<a class="headerlink" href="#model-interface" title="Permalink to this headline">¶</a></h2>
<p>A MISTK model implements the <cite>mistk.model.AbstractModel</cite> class. This class
provides a set of abstract methods that represent the model lifecycle and
must be implemented by the new model. Ultimately, these methods form the core of
the web endpoint service that is made available for every model implementation.</p>
<dl>
<dt><strong>do_initialize</strong> (objectives: list, props: dict, hparams: dict)</dt><dd><p>Called once the endpoint service has launched.  This would typically be the
first call made to the service. Perform any general setup and initialization.</p>
<dl class="field-list simple">
<dt class="field-odd">param objectives</dt>
<dd class="field-odd"><p>A list of model objectives intended to aid in its
setup and initialization. Possible values are:
‘training’, ‘prediction’, ‘streaming_prediction’, ‘generation’, ‘transfer_learning’.</p>
</dd>
<dt class="field-even">param props</dt>
<dd class="field-even"><p>A dictionary of settings or configuration values that are passed
from the ecosystem, but are not considered model hyperparameters.</p>
</dd>
<dt class="field-odd">param hparams</dt>
<dd class="field-odd"><p>A dictionary of hyperparameters that are used by the model.</p>
</dd>
</dl>
</dd>
<dt><strong>do_load_data</strong> (dataset_map: dict)</dt><dd><p>Instructs the container to load training, testing, or generation data (or at least
record in memory where the data is) from the supplied paths.</p>
<dl class="field-list">
<dt class="field-odd">param dataset_map</dt>
<dd class="field-odd"><p>A dictionary that maps string keys {train, test, generation} to a
MistkDataset object that contains information on the dataset to load.
The <cite>objectives</cite> values for this model determines which keys are present in
the map (i.e. a model with only a training objective should not depend on
a ‘test’ key to be present).</p>
<p>The MistkDataset values will require the following fields:</p>
<blockquote>
<div><p>object_info: A dictionary that stores metadata information for the
dataset. Only the ‘name’ and ‘kind’ fields are required, all other
fields are optional.</p>
<p>data_path: A string containing the path to the dataset root folder</p>
<p>modality: A string with value image, audio, video, or text</p>
<p>format: A string containing the name of the format of this dataset</p>
</div></blockquote>
</dd>
</dl>
</dd>
<dt><strong>do_build_model</strong> (path=None)</dt><dd><p>Instructs the service to build all necessary data structures given the
architecture and selected hyperparameters.</p>
<dl class="field-list simple">
<dt class="field-odd">param path</dt>
<dd class="field-odd"><p>The path to the model file or checkpoint that should be loaded.
Defaults to None if no file was specified in this model’s definition.</p>
</dd>
</dl>
</dd>
<dt><strong>do_train</strong> ()</dt><dd><p>Perform training with the previously supplied data.</p>
</dd>
<dt><strong>do_predict</strong> ()</dt><dd><p>Perform predictions with the previously supplied data.</p>
</dd>
<dt><strong>do_generate</strong> ()</dt><dd><p>Perform generations with the previously supplied data.</p>
</dd>
<dt><strong>do_pause</strong> ()</dt><dd><p>Pause the current training or testing.</p>
</dd>
<dt><strong>do_resume_training</strong> ()</dt><dd><p>Resume the previously paused training.</p>
</dd>
<dt><strong>do_resume_predict</strong> ()</dt><dd><p>Resume the previously paused predictions.</p>
</dd>
<dt><strong>do_save_predictions</strong> (dataPath)</dt><dd><p>Save the model predictions to the supplied data path. The predictions should
be saved as CSV with each row in the following format:</p>
<p>id,label[,confidence][,bounds]</p>
<dl class="field-list simple">
<dt class="field-odd">param dataPath</dt>
<dd class="field-odd"><p>The path to which the predictions should be saved.</p>
</dd>
</dl>
</dd>
<dt><strong>do_save_generations</strong> (dataPath)</dt><dd><p>Saves the generated media produced by the model to the supplied data path.</p>
<dl class="field-list simple">
<dt class="field-odd">param dataPath</dt>
<dd class="field-odd"><p>The path to which the generations should be saved.</p>
</dd>
</dl>
</dd>
<dt><strong>do_stream_predict</strong> (data_map: dict, details: bool)</dt><dd><p>Perform predictions on the input dict of id’s to base64 encoded data and
return a dict of id’s to predicted values.
The underlying format of the base64 encoded data should be the native
input format for the model.</p>
<dl class="field-list simple">
<dt class="field-odd">param data_map</dt>
<dd class="field-odd"><p>A dict of id’s to base64 encoded data.</p>
</dd>
<dt class="field-even">param details</dt>
<dd class="field-even"><p>Optional parameter for the model to provide additional details in the returned dict. Default value is False.</p>
</dd>
<dt class="field-odd">return</dt>
<dd class="field-odd"><p>A dict of id’s to predicted values. The id ‘details’ is a keyword used for additional details provided in Markdown or HTML.</p>
</dd>
</dl>
</dd>
<dt><strong>do_update_stream_properties</strong> (props: dict)</dt><dd><p>Updates the stream prediction properties for subsequent stream predict calls.</p>
<dl class="field-list simple">
<dt class="field-odd">param dict</dt>
<dd class="field-odd"><p>A dict that can be used for streaming properties.</p>
</dd>
</dl>
</dd>
<dt><strong>do_save_model</strong> (path)</dt><dd><p>Save a checkpoint of the model to the supplied data path. Format of the saved
file(s) is at the discretion of the model. The infrastructure associates
this checkpoint with this model.</p>
<dl class="field-list simple">
<dt class="field-odd">param path</dt>
<dd class="field-odd"><p>The path to which the model should be saved.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<div class="section" id="the-model-state-machine">
<h3>The Model State Machine<a class="headerlink" href="#the-model-state-machine" title="Permalink to this headline">¶</a></h3>
<p>Model implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the model methods that may be
called between them.</p>
<img alt="_images/state_machine.png" src="_images/state_machine.png" />
<p>The ‘Terminated’ state (and associated method ‘do_terminate’) is not
pictured but is a valid transition from any of the states depicted above.
Note that an internal ‘Failed’ state will be entered if the model
implementation throws an exception. No further model activities are permitted
from the ‘Failed’ state.</p>
<p>If a model workflow enters the ‘Failed’ state, then the workflow will need to be restarted
from the beginning. This is required in order to support various machine learning
technologies (ie. Tensorflow) that may not have a methodology to reset/resume their state
after a critical failure.</p>
</div>
<div class="section" id="initializing-a-model">
<h3>Initializing a Model<a class="headerlink" href="#initializing-a-model" title="Permalink to this headline">¶</a></h3>
<p>Initialization of a model loads the hyperparameters and model properties associated
with the model. Hyperparameters are defined by the algorithm that a model is based on.
Model properties are defined by a specific implementation of an algorithm (ie. a
PyTorch implementation of Densenet may have different properties than a
Tensorflow implementation). Below are sample hyperparameters and model properties
dictionaries that can be passed to a model implementation’s ‘do_initialize’ method.</p>
<div class="section" id="hyperparameters">
<h4>Hyperparameters<a class="headerlink" href="#hyperparameters" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="simple">
<dt>{</dt><dd><p>‘learning_rate’: 0.001,
‘weight_decay’: 0.004
‘momentum’: 0.9</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
</div>
<div class="section" id="model-properties">
<h4>Model Properties<a class="headerlink" href="#model-properties" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><dl class="simple">
<dt>{</dt><dd><p>‘arch’: ‘densenet’,
‘num_labels’: 1000,
‘model_load_file’: ‘checkpoint.pth’</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
</div>
</div>
<div class="section" id="loading-data">
<h3>Loading Data<a class="headerlink" href="#loading-data" title="Permalink to this headline">¶</a></h3>
<p>When loading data into a model instance using the <strong>do_load_data(dataset_map)</strong>
method inherited from ‘AbstractModel’, the dataset_map parameter must include
sufficient information for each dataset mapped to an objective {train, test, generate}.
The required fields include ‘object_info’, ‘data_path’, ‘modality’, and ‘format’
(Described in the Model API method documentation previously)
An example dataset map is provided below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_training_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;jpg&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_testing_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;jpg&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;generation&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_generation_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The dataset for generations should contain files that indicate the targets for generation.</p>
<p>Please note, that when using the RESTful API directly, where the user would be
submitting the JSON via the ‘load_data’ API call, the JSON keys would need to be
in camelcase format rather than underscored (ie. object_info becomes objectInfo).</p>
</div>
<div class="section" id="model-status">
<h3>Model Status<a class="headerlink" href="#model-status" title="Permalink to this headline">¶</a></h3>
<p>Model implementations are encouraged to report status pertaining to their
current workflow state back to the MISTK infrastructure by calling the
<strong>update_status(dict)</strong> method inherited from <cite>AbstractModel</cite> (note this method
is intended to be called by the model, not overridden as the methods above).
This method takes a dictionary object of key-value pairs defined by the model.
For example, the logistic regression model below updates its status with the number of
samples fit during training and the number of samples predicted during testing.</p>
</div>
<div class="section" id="predictions-and-ground-truth">
<h3>Predictions and Ground Truth<a class="headerlink" href="#predictions-and-ground-truth" title="Permalink to this headline">¶</a></h3>
<p>Model prediction output from the <strong>do_save_predictions</strong> method as well as
corresponding dataset ground truth should be CSV-formatted as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">,</span><span class="n">label</span><span class="p">[,</span><span class="n">confidence</span><span class="p">][,</span><span class="n">bounds</span><span class="p">]</span>
</pre></div>
</div>
<p>The <cite>id</cite> field can be arbitrary as long as predictions and ground truth use the
same values.
All columns except <cite>id</cite> may contain whitespace-separated values as necessary.
The confidence probabilities and bounds values are optional.</p>
<ul>
<li><p>Example Prediction CSV line for only id and label:</p>
<blockquote>
<div><p>mnist-test-00001,7</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and a single label, confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00000163,n03733805,.9,84 0 433 278</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and a single label, no confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00000163,n03733805,,84 0 433 278</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and multiple (3) label, confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00004833,n03733805 n03733805 n03733805,.9 .8 .8,85 93 350 355 301 306 421 428 0 5 469 373</p>
</div></blockquote>
</li>
<li><p>Example of <em>incorrect</em> Prediction CSV line where addition bounds and confidence will be ignored due to only 1 label:</p>
<blockquote>
<div><p>ILSVRC2012_val_00004833,n03733805,.9 .8 .8,85 93 350 355 301 306 421 428 0 5 469 373</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="example-model">
<h3>Example Model<a class="headerlink" href="#example-model" title="Permalink to this headline">¶</a></h3>
<p>The following example code implements a logistic regression algorithm
from scikit-learn with the MISTK model interface which operates on a common public dataset:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="kn">from</span> <span class="nn">mistk.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>

<span class="c1"># derive this model from AbstractModel</span>
<span class="k">class</span> <span class="nc">ScikitLearnLogisticRegressionModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># remember to call the base __init__</span>
      <span class="n">AbstractModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

      <span class="c1"># initialize our model variables</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="s1">&#39;scikit-logistic-regression-model.bin&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">do_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">props</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hparams</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">props</span> <span class="ow">or</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="n">objectives</span>

      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">)</span>

      <span class="k">if</span> <span class="s1">&#39;model_file_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;model_file_name&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">do_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="c1"># check for and load training data and/or test data</span>
      <span class="c1"># NOTE this model is coded to this particular (arbitrary)</span>
      <span class="c1"># dataset format</span>
      <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No datasets provided&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
          <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
          <span class="n">data_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/data.csv&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
          <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
          <span class="n">data_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/data.csv&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">do_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
          <span class="c1"># if we got a path to a saved model then load it</span>
          <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
              <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading model &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

              <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                  <span class="c1"># we decided to use python pickle to save and load</span>
                  <span class="c1"># model checkpoints in this model, but other models</span>
                  <span class="c1"># are free to use any format they desire</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
              <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># train with our previously loaded data</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_fit&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">)})</span>

  <span class="k">def</span> <span class="nf">do_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model to &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

      <span class="c1"># just saving a simple &#39;pickled&#39; model to disk</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
          <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">do_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># This is a future capability that is not supported at this time</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">do_resume_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># This is a future capability that is not supported at this time</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">do_resume_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># This is a future capability that is not supported at this time</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">do_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># predict with our previously loaded data</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_predicted&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)})</span>

  <span class="k">def</span> <span class="nf">do_save_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
      <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving predictions to &quot;</span> <span class="o">+</span> <span class="n">dataPath</span><span class="p">)</span>

      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
              <span class="c1"># write out a results csv that can be evaluated</span>
              <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">do_stream_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="c1"># stream prediction takes a dict of id&#39;s to base64 encoded data</span>
      <span class="c1"># and returns a dict of id&#39;s to predicted values</span>
      <span class="c1"># this model expects the underlying encoded data to be a JSON list of feature values</span>
      <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">detailed_data</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicting class for key &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
          <span class="n">data_row</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
          <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">data_row</span><span class="p">])</span>
          <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">detailed_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">([</span><span class="n">data_row</span><span class="p">])</span>
          
      <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
          <span class="c1"># additional details for predictions</span>
          <span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_stream_predict_details</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">detailed_data</span><span class="p">)</span>
              
      <span class="k">return</span> <span class="n">predictions</span>

  <span class="k">def</span> <span class="nf">_format_stream_predict_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">prediction_details</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Format stream predict details in the form of NGX Markdown </span>
<span class="sd">      :param predictions: predictions for each streaming image</span>
<span class="sd">      :param prediction_details: prediction probabilities for each streaming image</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;#Logistic Regression Model Results&quot;</span>
      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">These section contains details about the **Logistic Regression Model Results**.&lt;br/&gt;&lt;br/&gt;&quot;</span>
      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br/&gt;&lt;br/&gt;&quot;</span>
      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Trained Model Streaming Results&quot;</span>
      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br/&gt;&lt;br/&gt;&quot;</span>
        
      <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="n">prediction_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="n">details</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#### For image {image} with prediction of {predictions[image]}&quot;</span>
          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">| Class        | Probability |&quot;</span>
          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| ------------- |:-------------:|&quot;</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">classes_</span><span class="p">)):</span> 
              <span class="n">details</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| {self._regr.classes_[i]}        | {round(preds[0][i], 3)} |&quot;</span>
          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

  <span class="k">def</span> <span class="nf">do_update_stream_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;do_update_stream_properties called&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_stream_props</span> <span class="o">=</span> <span class="n">props</span>

  <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># nothing to clean up for this model</span>
      <span class="k">pass</span>
  
  <span class="k">def</span> <span class="nf">do_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Executes/resumes the generate activity</span>
<span class="sd">      This operation is currently not supported. </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;generate&#39;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
  <span class="k">def</span> <span class="nf">do_save_generations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Saves the current generations to the location specified</span>
<span class="sd">        </span>
<span class="sd">      :param dataPath: The location on the local file system or distributed</span>
<span class="sd">          file system where the generations will be saved</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;save_generations&#39;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
          <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="transfer-learning">
<h3>Transfer learning<a class="headerlink" href="#transfer-learning" title="Permalink to this headline">¶</a></h3>
<p>Model support of transfer learning is independent to each model implementation.
Model developers that use the MISTK library need to incorporate their implementation
features for transfer learning into their build_model and train methods. The PyTorch
implementation below builds their model with specific configurations when performing
transfer learning. The highlighted lines are relevant lines for transfer learning
in this PyTorch implementation.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">torch.optim</span>
<span class="kn">import</span> <span class="nn">torch.nn</span>
<span class="kn">import</span> <span class="nn">torch.autograd</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="kn">as</span> <span class="nn">transforms</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">mistk.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>
<span class="kn">from</span> <span class="nn">.folder</span> <span class="kn">import</span> <span class="n">ImageFolder</span>
<span class="kn">from</span> <span class="nn">.stream</span> <span class="kn">import</span> <span class="n">ImageStream</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">PyTorchImageNetModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">AbstractModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Completed PytorchImageNetModel construction&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">props</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hparams</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_initialize called in pytorch model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">props</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="n">objectives</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="hll">        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
</span><span class="hll">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No datasets provided&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
</span><span class="hll">            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
</span><span class="hll">            <span class="n">tr_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;ILSVRC/Data/CLS-LOC/train&quot;</span><span class="p">)</span>
</span><span class="hll">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tr_data_path</span><span class="p">):</span>
</span><span class="hll">                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looks like this is NOT an imagenet training dataset&#39;</span><span class="p">)</span>
</span>                <span class="n">tr_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_train_data_loader</span><span class="p">(</span><span class="n">tr_data_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
            <span class="n">te_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;ILSVRC/Data/CLS-LOC/val&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">te_data_path</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looks like this is NOT an imagenet testing dataset&#39;</span><span class="p">)</span>
                <span class="n">te_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>
<span class="hll">                <span class="n">labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;ground_truth.csv&#39;</span><span class="p">)</span>
</span><span class="hll">            <span class="k">else</span><span class="p">:</span>
</span><span class="hll">                <span class="n">labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;LOC_val_solution.csv&#39;</span><span class="p">)</span>
</span><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_data_loader</span><span class="p">(</span><span class="n">te_data_path</span><span class="p">,</span>
</span>                                                                <span class="n">labels_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="s1">&#39;densenet161&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading new model for &quot;</span> <span class="o">+</span> <span class="n">arch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">arch</span><span class="p">]()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="s1">&#39;checkpoint_load_file&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;checkpoint_load_file&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
                <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Specified checkpoint file is not valid, ignoring&#39;</span><span class="p">)</span>
                <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No checkpoint file specified&#39;</span><span class="p">)</span>
            <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">have_checkpoint</span><span class="p">:</span>
            <span class="c1"># imagenet has 1000 labels and that is the assumed default</span>
            <span class="n">number_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_labels&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">number_labels</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting number of labels to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_labels</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">set_classifier</span><span class="p">(</span><span class="n">number_labels</span><span class="p">)</span>

            <span class="c1"># Need to set this before the checkpoint is loaded</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alexnet&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vgg&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished loading model parallelization features&#39;</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading model checkpoint from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">checkpoint_path</span><span class="p">)</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_state_file</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">number_labels</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Assuming optimizer was used for transfer learning&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_classifier</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading optimizer settings from checkpoint&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="s1">&#39;model_load_file&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
                <span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;model_load_file&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">remote_path</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading model load file from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remote_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_state_file</span><span class="p">(</span><span class="n">remote_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Specified model load file is not valid, ignoring&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No model load file specified&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;transfer_learning&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Freezing hidden layers for transfer learning&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c1"># imagenet has 1000 labels and that is the assumed default</span>
                <span class="n">number_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_labels&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting number of labels to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_labels</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">set_classifier</span><span class="p">(</span><span class="n">number_labels</span><span class="p">)</span>

            <span class="c1"># This will need to be loaded after the model load</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alexnet&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vgg&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished loading model parallelization features&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;transfer_learning&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_classifier</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">:</span>
            <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">classes_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">do_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_save_file&#39;</span><span class="p">,</span> <span class="s1">&#39;checkpoint.pth&#39;</span><span class="p">)</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model checkpoint to &quot;</span> <span class="o">+</span> <span class="n">checkpoint_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
                    <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;optimizer&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="p">},</span> <span class="n">writer</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">:</span>
            <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting training at epoch </span><span class="si">%s</span><span class="s1"> until epoch </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;90&#39;</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_learning_rate</span><span class="p">()</span>

            <span class="n">losses</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>
            <span class="n">top1</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>
            <span class="n">top5</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">async</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">async</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
                <span class="n">target_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target_var</span><span class="p">)</span>

                <span class="n">acc1</span><span class="p">,</span> <span class="n">acc5</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target_var</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">top1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">top5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                                   <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Epoch: [</span><span class="si">%i</span><span class="s1">][</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                  <span class="s1">&#39;Loss {loss.val:</span><span class="si">%.4f</span><span class="s1">} ({loss.avg:</span><span class="si">%.4f</span><span class="s1">})</span><span class="se">\t</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;Acc@1 {top1.val:</span><span class="si">%.3f</span><span class="s1">} ({top1.avg:</span><span class="si">%.3f</span><span class="s1">})</span><span class="se">\t</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;Acc@5 {top5.val:</span><span class="si">%.3f</span><span class="s1">} ({top5.avg:</span><span class="si">%.3f</span><span class="s1">})&#39;</span><span class="p">,</span>
                      <span class="n">losses</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">losses</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">top1</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">top5</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">top5</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_resume_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_resume_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting predictions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">rowid</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Test: [</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_stream_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_stream_data_loader</span><span class="p">(</span><span class="n">data_map</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
            <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicted class is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="k">else</span> <span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Test: [</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span>
    
    <span class="k">def</span> <span class="nf">do_update_stream_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;do_update_stream_properties called&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_props</span> <span class="o">=</span> <span class="n">props</span>

    <span class="k">def</span> <span class="nf">do_save_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
        <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving predictions to &quot;</span> <span class="o">+</span> <span class="n">dataPath</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># write out a results csv that can be evaluated by the ERE</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_train_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading training dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">normalize</span><span class="p">,]))</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loader</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>

    <span class="k">def</span> <span class="nf">do_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">create_stream_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading stream dataset&#39;</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageStream</span><span class="p">(</span><span class="n">data_map</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                    <span class="n">normalize</span><span class="p">,]))</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loader</span>

    <span class="k">def</span> <span class="nf">create_test_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">ground_truth_file</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading test dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ground_truth_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">path_to_label</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ground_truth_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ImageId&#39;</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.JPEG&#39;</span><span class="p">)</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">path_to_label</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                        <span class="n">label_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">label_set</span><span class="p">)</span>

            <span class="n">label_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
                <span class="n">label_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

            <span class="n">path_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">path_to_label</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">path_to_idx</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                    <span class="n">normalize</span><span class="p">,]),</span> <span class="n">path_to_idx</span><span class="o">=</span><span class="n">path_to_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                    <span class="n">normalize</span><span class="p">,]))</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>

        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loader</span><span class="p">,</span> <span class="n">classes</span>

    <span class="k">def</span> <span class="nf">load_state_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading state file from &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adjust_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">//</span> <span class="mi">30</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>


<span class="k">class</span> <span class="nc">AverageMeter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes and stores the average and current value&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

<span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)):</span>
    <span class="sd">&quot;&quot;&quot;Computes the accuracy over the k top predictions for the specified values of k&quot;&quot;&quot;</span>
    <span class="n">maxk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">topk</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">maxk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">topk</span><span class="p">:</span>
        <span class="n">correct_k</span> <span class="o">=</span> <span class="n">correct</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct_k</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</td></tr></table></div>
<p>Model developers will need to specify in their model properties that they are performing
transfer learning when using this model for that purpose.</p>
</div>
</div>
<div class="section" id="data-transformation-interface">
<h2>Data Transformation Interface<a class="headerlink" href="#data-transformation-interface" title="Permalink to this headline">¶</a></h2>
<p>The MISTK API provides an interface for creating data transformation plugins. These
plugins run within docker containers similar to models. A MISTK data transform
implements the ‘mistk.transform.AbstractTransformPlugin’ abstract class. This class
provides a set of abstract methods that represent the data transform lifecycle and
must be implemented by the new data transform plugin. Ultimately, these methods form the core of
the web endpoint service that is made available for every data transform implementation.</p>
<dl class="simple">
<dt><strong>do_transform</strong> (inputDirs: list, outputDir: string, properties: dict)</dt><dd><p>Performs a data transformation using the data provided in the input directories
and stores the resulting dataset(s) in the output directory.</p>
<dl class="field-list simple">
<dt class="field-odd">param inputDirs</dt>
<dd class="field-odd"><p>A list of directory paths from which to load input datasets from.</p>
</dd>
<dt class="field-even">param outputDir</dt>
<dd class="field-even"><p>The directory path where the output dataset will be stored</p>
</dd>
<dt class="field-odd">param props</dt>
<dd class="field-odd"><p>A dictionary of settings or configuration values that are passed
to the transformation.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<div class="section" id="the-transformation-state-machine">
<h3>The Transformation State Machine<a class="headerlink" href="#the-transformation-state-machine" title="Permalink to this headline">¶</a></h3>
<p>Data transformation plugin implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the data transform plugin methods
that may be called between them.</p>
<img alt="_images/transform_state_machine.png" src="_images/transform_state_machine.png" />
<p>A data transform plugin instance will automatically go to the Ready state if its
container instance successfully starts up. After completing a transformation, it
will return to the Ready state so that multiple transformations can be executed
using the same container instance.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>The following example code implements a ground truth transform for an MNIST formatted dataset
with the MISTK data transformation interfacet:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mistk.transform.abstract_transform_plugin</span> <span class="kn">import</span> <span class="n">AbstractTransformPlugin</span>

<span class="k">class</span> <span class="nc">ground_truth_transform</span><span class="p">(</span><span class="n">AbstractTransformPlugin</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminates the transform plugin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AbstractTransformPlugin</span><span class="o">.</span><span class="n">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">do_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputDirs</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the transformation</span>
<span class="sd">        </span>
<span class="sd">        :param inputDirs: A list of input directories</span>
<span class="sd">        :param outputDir: The output directory</span>
<span class="sd">        :param properties: Transformation plugin properties. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_path</span><span class="o">=</span><span class="n">inputDirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_transform</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">outputDir</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ground_truth_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputPath</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a ground truth transform</span>
<span class="sd">        </span>
<span class="sd">        :param inputPath: The directory path where input files are found</span>
<span class="sd">        :param outputPath: The directory path where the output files will be stored. </span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">mnist_train_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">mnist_test_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="s1">&#39;ground_truth.csv&#39;</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                
                <span class="c1"># Write the header</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;id, label</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                
                <span class="c1"># Process the training data</span>
                <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_labels</span><span class="p">))))</span>                        
                
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_labels</span><span class="p">)):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_train_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">row_id</span> <span class="o">=</span> <span class="s1">&#39;mnist-train-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding_size</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>                
                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="c1">#idx+=1</span>
                 
                <span class="c1"># Process the test data</span>
                <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_labels</span><span class="p">))))</span>                        
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_labels</span><span class="p">)):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_test_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">row_id</span> <span class="o">=</span> <span class="s1">&#39;mnist-test-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding_size</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>                
                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                    
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unexpected error caught during transform&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ex</span>


<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">basedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the MNIST formatted dataset.</span>

<span class="sd">    :param basedir: The base directory from which to load files</span>
<span class="sd">    :param is_training: Flag indicating whether this is for training data</span>
<span class="sd">    </span>
<span class="sd">    :return: A tuple of Numpy arrays: `(x_train, y_train).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;train-images-idx3-ubyte.gz&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t*k-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;t*k-images-idx3-ubyte.gz&#39;</span><span class="p">]</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading files from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">basedir</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added file </span><span class="si">%s</span><span class="s2"> to load path&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbpath</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">lbpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">imgpath</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">imgpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="evaluation-interface">
<h2>Evaluation Interface<a class="headerlink" href="#evaluation-interface" title="Permalink to this headline">¶</a></h2>
<p>The MISTK API provides an interface for creating evaluation plugins to evaluate models
against specific metrics. These plugins run within docker containers similar to models.
A MISTK evaluation implements the ‘mistk.evaluation.AbstractEvaluationPlugin’ abstract class.
This class provides a set of abstract methods that represent the evaluation lifecycle and
must be implemented by the new evaluation plugin. Ultimately, these methods form the core of
the web endpoint service that is made available for every evaluation implementation.</p>
<dl class="simple">
<dt><strong>do_evaluate</strong> (assessment_type: string, metrics: list, input_data_path: string, evaluation_input_format: string, ground_truth_path: string, evaluation_path: string, properties: dict)</dt><dd><p>Performs an evaluation using the ground truth data and predictions data for the assessment type and metrics
specified and stores the resulting evaluation in the output directory.</p>
<dl class="field-list simple">
<dt class="field-odd">param assessment_type</dt>
<dd class="field-odd"><p>The evaluation type. One of {‘BinaryClassification’,
‘MultilabelClassification’, ‘MulticlassClassification’, ‘Regression’}</p>
</dd>
<dt class="field-even">param metrics</dt>
<dd class="field-even"><p>Specific metrics to evaluate against instead of all metrics defined by assessment_type</p>
</dd>
<dt class="field-odd">param input_data_path</dt>
<dd class="field-odd"><p>Path to input data for the evaluation</p>
</dd>
<dt class="field-even">param evaluation_input_format</dt>
<dd class="field-even"><p>The format of the input data. One of {predictions, generations}</p>
</dd>
<dt class="field-odd">param ground_truth_path</dt>
<dd class="field-odd"><p>The directory path where the ground_truth.csv file is located</p>
</dd>
<dt class="field-even">param evaluation_path</dt>
<dd class="field-even"><p>A directory path to where the evaluation.json output file will be stored</p>
</dd>
<dt class="field-odd">param properties</dt>
<dd class="field-odd"><p>A dictionary of key value pairs for evaluation plugin arguments.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<div class="section" id="evaluation-metrics">
<h3>Evaluation Metrics<a class="headerlink" href="#evaluation-metrics" title="Permalink to this headline">¶</a></h3>
<p>Metrics are loaded for the evaluation container based on the metrics.json file. This JSON file contains a list
of Metric objects to describe the metric and how it will be executed.</p>
<p>The Metric values will require the following fields:</p>
<blockquote>
<div><p>object_info: A dictionary that stores metadata information for the
dataset. Only the ‘name’ and ‘kind’ fields are required, all other
fields are optional.</p>
<p>image_id: The image id for the evaluation container to run.</p>
<p>assessment_types: The assessment type for the metric, e.g. MulticlassClassification.</p>
</div></blockquote>
<p>An example for a metric:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;objectInfo&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Metric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sklearn.metrics.r2_score&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;imageId&quot;</span><span class="p">:</span> <span class="s2">&quot;docker-registry:5000/sml-evaluators/sklearn&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assessmentTypes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Regression&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Metric values can optionally contain the following fields for accessing external metrics from other Python packages:</p>
<blockquote>
<div><p>package: (str) The name of the package containing the implementation of this external metric.</p>
<p>method: (str) The name of the method from <cite>package</cite> to be called when executing the external metric.</p>
<p>defaultArgs: (dict) The default arguments passed to the method when the metric is called.
These key/value pairs can also be used as properties for the metric.</p>
</div></blockquote>
<p>An example for an external metric:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;objectInfo&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Metric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;r2_score&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;imageId&quot;</span><span class="p">:</span> <span class="s2">&quot;docker-registry:5000/sml-evaluators/sklearn&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assessmentTypes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Regression&quot;</span><span class="p">],</span>
  <span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="s2">&quot;sklearn.metrics&quot;</span><span class="p">,</span>
  <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;r2_score&quot;</span><span class="p">,</span>
  <span class="s2">&quot;defaultArgs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;multioutput&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform_average&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-evaluation-state-machine">
<h3>The Evaluation State Machine<a class="headerlink" href="#the-evaluation-state-machine" title="Permalink to this headline">¶</a></h3>
<p>Evaluation plugin implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the evaluation plugin methods
that may be called between them.</p>
<img alt="_images/evaluation_state_machine.png" src="_images/evaluation_state_machine.png" />
<p>A evaluation plugin instance will automatically go to the Started state if its
container instance successfully starts up. After completing a evaluation, it
will return to the Ready state so that multiple evaluations can be executed
using the same container instance.</p>
</div>
<div class="section" id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The following example code implements a sklearn evaluation metrics with the MISTK evaluation metrics interfacet:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">##############################################################################</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">##############################################################################</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MultiLabelBinarizer</span>

<span class="kn">from</span> <span class="nn">mistk.evaluation.abstract_evaluation_plugin</span> <span class="kn">import</span> <span class="n">AbstractEvaluationPlugin</span>
<span class="kn">from</span> <span class="nn">mistk.evaluation.util.convert</span> <span class="kn">import</span> <span class="n">csv_Predictions_to_DataFrame</span><span class="p">,</span> <span class="n">csv_Groundtruth_to_DataFrame</span>
<span class="kn">from</span> <span class="nn">mistk</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="k">class</span> <span class="nc">SklearnEvaluation</span> <span class="p">(</span><span class="n">AbstractEvaluationPlugin</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AbstractEvaluationPlugin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">None</span>
  
    <span class="k">def</span> <span class="nf">do_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assessment_type</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">input_data_path</span><span class="p">,</span> <span class="n">evaluation_input_format</span><span class="p">,</span> <span class="n">ground_truth_path</span><span class="p">,</span> <span class="n">evaluation_path</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs metrics&#39; evaluation using the predictions and ground truth files provided.</span>
<span class="sd">        Stored the assessment results as a JSON file in the evaluation_path</span>
<span class="sd">        </span>
<span class="sd">        :param assessment_type: The evaluation assessment type. One of {&#39;BinaryClassification&#39;, </span>
<span class="sd">            &#39;MultilabelClassification&#39;, &#39;MulticlassClassification&#39;, &#39;Regression&#39;}</span>
<span class="sd">        :param metrics: Specific metrics to evaluate against instead of all metrics defined by assessment_type</span>
<span class="sd">        :param input_data_path: Path to input data for the evaluation</span>
<span class="sd">        :param evaluation_input_format: The format of the input data</span>
<span class="sd">        :param ground_truth_path: The directory path where the ground_truth.csv file is located</span>
<span class="sd">        :param evaluation_path: A directory path to where the evaluation.json output file will be stored</span>
<span class="sd">        :param properties: A dictionary of key value pairs for evaluation plugin arguments. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">evaluation_input_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;predictions&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;EvaluationInputFormat </span><span class="si">%s</span><span class="s2"> is not supported by this Metric Evaluator, only &#39;predictions&#39; are supported&quot;</span> <span class="o">%</span> <span class="n">evaluation_input_format</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
 
        <span class="c1"># load prediction results</span>
        <span class="n">full_predictions_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_data_path</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">csv_Predictions_to_DataFrame</span><span class="p">(</span><span class="n">full_predictions_path</span><span class="p">)</span>
        
        <span class="c1"># load ground truth</span>
        <span class="n">full_ground_truth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ground_truth_path</span><span class="p">,</span> <span class="s2">&quot;ground_truth.csv&quot;</span><span class="p">)</span>
        <span class="n">truth_df</span> <span class="o">=</span> <span class="n">csv_Groundtruth_to_DataFrame</span><span class="p">(</span><span class="n">full_ground_truth_path</span><span class="p">)</span>
        
        <span class="c1"># match ground truth to results by id </span>
        <span class="n">truth_df</span> <span class="o">=</span> <span class="n">truth_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;rowid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;rowid&#39;</span><span class="p">])]</span>
            
        <span class="c1"># sort the rows by id</span>
        <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">truth_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running for metrics </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metrics</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MultilabelClassification&quot;</span> <span class="ow">or</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MulticlassClassification&quot;</span><span class="p">:</span>
            <span class="c1"># create matrices for labels and confidence</span>
            <span class="n">label_mlb</span> <span class="o">=</span> <span class="n">MultiLabelBinarizer</span><span class="p">()</span>
            <span class="n">parsed_truth_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                   <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
            <span class="n">parsed_results_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                     <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
            <span class="n">label_mlb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_truth_labels</span><span class="p">,</span> <span class="n">parsed_results_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">parsed_truth_labels</span><span class="p">)</span>
            <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">parsed_results_labels</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">results_df</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
                <span class="n">parsed_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                     <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">label_classes</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_results_labels</span><span class="p">):</span>
                    <span class="n">confidence_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                        <span class="n">label_pos</span> <span class="o">=</span> <span class="n">label_classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                        <span class="n">confidence_row</span><span class="p">[</span><span class="n">label_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">parsed_confidence</span><span class="p">[</span><span class="n">row_index</span><span class="p">][</span><span class="n">col_index</span><span class="p">])</span>  <span class="c1">#pylint: disable=no-member</span>
                    <span class="n">confidence_matrix</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_row</span>
        <span class="k">elif</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;Regression&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">truth_labels_matrix</span><span class="p">):</span>
                    <span class="n">truth_labels_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                
            <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="p">):</span>
                    <span class="n">results_labels_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                
            <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_matrix</span><span class="p">):</span>
                    <span class="n">confidence_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                   <span class="k">else</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                     <span class="k">else</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
                                 <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
                                 <span class="k">else</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
        <span class="n">eval_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">modules_cache</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span>  <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modules_cache</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception importing plugin module &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                    <span class="n">modules_cache</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot load &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading cached module&quot;</span><span class="p">)</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">modules_cache</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">]</span>
                        
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot; in &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
                
                <span class="n">args</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_labels</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_labels</span><span class="p">]</span> <span class="o">=</span> <span class="n">truth_labels_matrix</span>
                        
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_bounds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_labels</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_labels</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_labels_matrix</span>
                        
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_scores</span> <span class="ow">and</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">results_df</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>           
                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_scores</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_matrix</span>
                    
                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_bounds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                                            
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">evalResult</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Something bad happened calling &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">evalResult</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="c1"># convert to native types</span>
                        <span class="n">evalResultAsList</span> <span class="o">=</span> <span class="n">evalResult</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MultilabelClassification&quot;</span> <span class="ow">or</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MulticlassClassification&quot;</span><span class="p">:</span>
                            <span class="c1"># map labels to their values in the results</span>
                            <span class="n">label_classes</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalResultAsList</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_classes</span><span class="p">):</span>
                                <span class="n">evalResultAsDict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_classes</span><span class="p">):</span>
                                    <span class="n">evalResultAsDict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span> <span class="o">=</span> <span class="n">evalResultAsList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsDict</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsList</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsList</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">):</span>
                        <span class="c1"># convert to native type</span>
                        <span class="n">evalResultAsScalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">evalResult</span><span class="p">)</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsScalar</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="c1"># kind of a cheat to cover the case where a native type has numpy elements</span>
                        <span class="c1"># which some scikit-learn methods inexplicably return</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evalResult</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResult</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot; does not exist in &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>  
                
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed metric &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                
        <span class="n">eval_dict_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">eval_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 
        <span class="n">filename</span> <span class="o">=</span> <span class="n">evaluation_path</span> <span class="o">+</span> <span class="s2">&quot;/eval_results_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing eval results to &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span> 
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">eval_dict_json</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate the MISTK Evaluation Metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AbstractEvaluationPlugin</span><span class="o">.</span><span class="n">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intro.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>