<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guide &mdash; MISTK  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Getting Started" href="intro.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MISTK
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#model-interface">Model Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-model-state-machine">The Model State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-a-model">Initializing a Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hyperparameters">Hyperparameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-properties">Model Properties</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#loading-data">Loading Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-status">Model Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="#predictions-and-ground-truth">Predictions and Ground Truth</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-model-with-csv-output">Example Model with CSV Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-model-with-json-output">Example Model with JSON Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#streaming-predictions-source">Streaming Predictions Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transfer-learning">Transfer learning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ensemble-models">Ensemble Models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#data-transformation-interface">Data Transformation Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-transformation-state-machine">The Transformation State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#evaluation-interface">Evaluation Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#evaluation-metrics">Evaluation Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-evaluation-state-machine">The Evaluation State Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">MISTK API</a></li>
<li class="toctree-l1"><a class="reference internal" href="gaming.html">Gaming</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MISTK</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/guide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="guide">
<h1>Guide<a class="headerlink" href="#guide" title="Permalink to this heading"></a></h1>
<section id="model-interface">
<h2>Model Interface<a class="headerlink" href="#model-interface" title="Permalink to this heading"></a></h2>
<p>A MISTK model implements the <cite>mistk.model.AbstractModel</cite> class. This class
provides a set of abstract methods that represent the model lifecycle and
must be implemented by the new model. Ultimately, these methods form the core of
the web endpoint service that is made available for every model implementation.</p>
<dl>
<dt><strong>do_initialize</strong> (objectives: list, props: dict, hparams: dict)</dt><dd><p>Called once the endpoint service has launched.  This would typically be the
first call made to the service. Perform any general setup and initialization.</p>
<dl class="field-list simple">
<dt class="field-odd">param objectives<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of model objectives intended to aid in its
setup and initialization. Possible values are:
‘training’, ‘prediction’, ‘streaming_prediction’, ‘generation’, ‘transfer_learning’.</p>
</dd>
<dt class="field-even">param props<span class="colon">:</span></dt>
<dd class="field-even"><p>A dictionary of settings or configuration values that are passed
from the ecosystem, but are not considered model hyperparameters.</p>
</dd>
<dt class="field-odd">param hparams<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dictionary of hyperparameters that are used by the model.</p>
</dd>
</dl>
</dd>
<dt><strong>do_load_data</strong> (dataset_map: dict)</dt><dd><p>Instructs the container to load training, testing, or generation data (or at least
record in memory where the data is) from the supplied paths.</p>
<dl class="field-list">
<dt class="field-odd">param dataset_map<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dictionary that maps string keys {train, test, generation} to a
MistkDataset object that contains information on the dataset to load.
The <cite>objectives</cite> values for this model determines which keys are present in
the map (i.e. a model with only a training objective should not depend on
a ‘test’ key to be present).</p>
<p>The MistkDataset values will require the following fields:</p>
<blockquote>
<div><p>object_info: A dictionary that stores metadata information for the
dataset. Only the ‘name’ and ‘kind’ fields are required, all other
fields are optional.</p>
<p>data_path: A string containing the path to the dataset root folder</p>
<p>modality: A string with value image, audio, video, or text</p>
<p>format: A string containing the name of the format of this dataset</p>
</div></blockquote>
</dd>
</dl>
</dd>
<dt><strong>do_build_model</strong> (path=None)</dt><dd><p>Instructs the service to build all necessary data structures given the
architecture and selected hyperparameters.</p>
<dl class="field-list simple">
<dt class="field-odd">param path<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path to the model file or checkpoint that should be loaded.
Defaults to None if no file was specified in this model’s definition.</p>
</dd>
</dl>
</dd>
<dt><strong>do_build_ensemble</strong> (ensemble_path=None, model_paths: dict=None)</dt><dd><p>Instructs the service to build all necessary models used for the ensemble model.</p>
<dl class="field-list simple">
<dt class="field-odd">param ensemble_path<span class="colon">:</span></dt>
<dd class="field-odd"><p>The directory path to the model file or checkpoint that should be loaded.
Defaults to None if no file was specified in this model’s definition.</p>
</dd>
<dt class="field-even">param model_paths<span class="colon">:</span></dt>
<dd class="field-even"><p>The directory paths to the model files in a dictionary.
The key is the model name with the value being the model path.</p>
</dd>
</dl>
</dd>
<dt><strong>do_train</strong> ()</dt><dd><p>Perform training with the previously supplied data.</p>
</dd>
<dt><strong>do_predict</strong> ()</dt><dd><p>Perform predictions with the previously supplied data.</p>
</dd>
<dt><strong>do_generate</strong> ()</dt><dd><p>Perform generations with the previously supplied data.</p>
</dd>
<dt><strong>do_miniaturize</strong> (dataPath, includeHalfPrecision)</dt><dd><blockquote>
<div><p>Perform miniaturization with the supplied data.</p>
<dl class="field-list simple">
<dt class="field-odd">param dataPath<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path to which the miniaturized model should be saved.</p>
</dd>
</dl>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">param includeHalfPrecision<span class="colon">:</span></dt>
<dd class="field-odd"><p>Miniaturize using half point precision format (FP16) for the model</p>
</dd>
</dl>
</dd>
<dt><strong>do_pause</strong> ()</dt><dd><p>Pause the current training or testing.</p>
</dd>
<dt><strong>do_resume_training</strong> ()</dt><dd><p>Resume the previously paused training.</p>
</dd>
<dt><strong>do_resume_predict</strong> ()</dt><dd><p>Resume the previously paused predictions.</p>
</dd>
<dt><strong>do_save_predictions</strong> (dataPath)</dt><dd><p>Save the model predictions to the supplied data path. The predictions should
be saved as either a CSV file or a JSON file.</p>
<dl class="field-list simple">
<dt class="field-odd">param dataPath<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path to which the predictions should be saved.</p>
</dd>
</dl>
<ul class="simple">
<li><p>CSV file with each row in the following format:</p></li>
</ul>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">,</span><span class="n">label</span><span class="p">[,</span><span class="n">confidence</span><span class="p">][,</span><span class="n">bounds</span><span class="p">]</span>
</pre></div>
</div>
<hr class="docutils" />
<blockquote>
<div><ul class="simple">
<li><p>JSON file utilizing the MistkDataRecordList format where “items” is a list of MistkDataRecord objects.
The MistkDataRecord requires a “recordId” String field
for the id and a “values” list field where each “value” is a dictionary for label, confidence, and bounds.</p></li>
</ul>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;recordId&quot;</span><span class="p">:</span> <span class="s2">&quot;id_value&quot;</span><span class="p">,</span>
      <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;label1_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;confidence1_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;b3&quot;</span><span class="p">,</span> <span class="s2">&quot;b4&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;label2_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;confidence2_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;b3&quot;</span><span class="p">,</span> <span class="s2">&quot;b4&quot;</span><span class="p">]</span>
         <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt><strong>do_save_generations</strong> (dataPath)</dt><dd><p>Saves the generated media produced by the model to the supplied data path.</p>
<dl class="field-list simple">
<dt class="field-odd">param dataPath<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path to which the generations should be saved.</p>
</dd>
</dl>
</dd>
<dt><strong>do_stream_predict</strong> (data_map: dict, details: bool)</dt><dd><p>Perform predictions on the input dict of id’s to base64 encoded data and
return a dict of id’s to predicted values.
The underlying format of the base64 encoded data should be the native
input format for the model.</p>
<dl class="field-list simple">
<dt class="field-odd">param data_map<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dict of id’s to base64 encoded data.</p>
</dd>
<dt class="field-even">param details<span class="colon">:</span></dt>
<dd class="field-even"><p>Optional parameter for the model to provide additional details in the returned dict. Default value is False.</p>
</dd>
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dict of id’s to predicted values. The id ‘details’ is a keyword used for additional details provided in Markdown or HTML.</p>
</dd>
</dl>
</dd>
<dt><strong>do_stream_predict_source</strong> (source: str, format: str, props: dict)</dt><dd><p>Perform predictions based on the source and returns a streaming response
for the predicted values. To add a new prediction to the streaming response, the
method <cite>update_source_predictions</cite> must be used to provide the MISTK service with results.
See the <cite>Streaming Predictions Source</cite> section below for more information.</p>
<dl class="field-list simple">
<dt class="field-odd">param source<span class="colon">:</span></dt>
<dd class="field-odd"><p>The source for streaming data. Generally, the source will be a URL to the video or
device for the actual data.</p>
</dd>
<dt class="field-even">param format<span class="colon">:</span></dt>
<dd class="field-even"><p>The format indicator of the input.  Used by the model to
differentiate between multiple accepted formats.</p>
</dd>
<dt class="field-odd">param props<span class="colon">:</span></dt>
<dd class="field-odd"><p>Optional parameter for the model to provide additional properties when predicting.</p>
</dd>
</dl>
</dd>
<dt><strong>do_update_stream_properties</strong> (props: dict)</dt><dd><p>Updates the stream prediction properties for subsequent stream predict calls.</p>
<dl class="field-list simple">
<dt class="field-odd">param dict<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dict that can be used for streaming properties.</p>
</dd>
</dl>
</dd>
<dt><strong>do_save_model</strong> (path)</dt><dd><p>Save a checkpoint of the model to the supplied data path. Format of the saved
file(s) is at the discretion of the model. The infrastructure associates
this checkpoint with this model.</p>
<dl class="field-list simple">
<dt class="field-odd">param path<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path to which the model should be saved.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<section id="the-model-state-machine">
<h3>The Model State Machine<a class="headerlink" href="#the-model-state-machine" title="Permalink to this heading"></a></h3>
<p>Model implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the model methods that may be
called between them.</p>
<img alt="_images/state_machine.png" src="_images/state_machine.png" />
<p>The ‘Terminated’ state (and associated method ‘do_terminate’) is not
pictured but is a valid transition from any of the states depicted above.
Note that an internal ‘Failed’ state will be entered if the model
implementation throws an exception. No further model activities are permitted
from the ‘Failed’ state.</p>
<p>If a model workflow enters the ‘Failed’ state, then the workflow will need to be restarted
from the beginning. This is required in order to support various machine learning
technologies (ie. Tensorflow) that may not have a methodology to reset/resume their state
after a critical failure.</p>
</section>
<section id="initializing-a-model">
<h3>Initializing a Model<a class="headerlink" href="#initializing-a-model" title="Permalink to this heading"></a></h3>
<p>Initialization of a model loads the hyperparameters and model properties associated
with the model. Hyperparameters are defined by the algorithm that a model is based on.
Model properties are defined by a specific implementation of an algorithm (ie. a
PyTorch implementation of Densenet may have different properties than a
Tensorflow implementation). Below are sample hyperparameters and model properties
dictionaries that can be passed to a model implementation’s ‘do_initialize’ method.</p>
<section id="hyperparameters">
<h4>Hyperparameters<a class="headerlink" href="#hyperparameters" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
  <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.004</span>
  <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="model-properties">
<h4>Model Properties<a class="headerlink" href="#model-properties" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="s1">&#39;densenet&#39;</span><span class="p">,</span>
  <span class="s1">&#39;num_labels&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="s1">&#39;model_load_file&#39;</span><span class="p">:</span> <span class="s1">&#39;checkpoint.pth&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="loading-data">
<h3>Loading Data<a class="headerlink" href="#loading-data" title="Permalink to this heading"></a></h3>
<p>When loading data into a model instance using the <strong>do_load_data(dataset_map)</strong>
method inherited from ‘AbstractModel’, the dataset_map parameter must include
sufficient information for each dataset mapped to an objective {train, test, generate}.
The required fields include ‘object_info’, ‘data_path’, ‘modality’, and ‘format’
(Described in the Model API method documentation previously)
An example dataset map is provided below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_training_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;jpg&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_testing_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;jpg&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;generation&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="s2">&quot;object_info&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;image_generation_set&quot;</span><span class="p">,</span>
       <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;MistkDataset&quot;</span>
     <span class="p">},</span>
     <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/data&quot;</span><span class="p">,</span>
     <span class="s2">&quot;modality&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
     <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The dataset for generations should contain files that indicate the targets for generation.</p>
<p>Please note, that when using the RESTful API directly, where the user would be
submitting the JSON via the ‘load_data’ API call, the JSON keys would need to be
in camelcase format rather than underscored (ie. object_info becomes objectInfo).</p>
</section>
<section id="model-status">
<h3>Model Status<a class="headerlink" href="#model-status" title="Permalink to this heading"></a></h3>
<p>Model implementations are encouraged to report status pertaining to their
current workflow state back to the MISTK infrastructure by calling the
<strong>update_status(dict)</strong> method inherited from <cite>AbstractModel</cite> (note this method
is intended to be called by the model, not overridden as the methods above).
This method takes a dictionary object of key-value pairs defined by the model.
For example, the logistic regression model below updates its status with the number of
samples fit during training and the number of samples predicted during testing.</p>
</section>
<section id="predictions-and-ground-truth">
<h3>Predictions and Ground Truth<a class="headerlink" href="#predictions-and-ground-truth" title="Permalink to this heading"></a></h3>
<p>Model prediction output from the <strong>do_save_predictions</strong> method as well as
corresponding dataset ground truth should be formatted as follows</p>
<p><strong>CSV Format</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span><span class="p">,</span><span class="n">label</span><span class="p">[,</span><span class="n">confidence</span><span class="p">][,</span><span class="n">bounds</span><span class="p">]</span>
</pre></div>
</div>
<p>The <cite>id</cite> field can be arbitrary as long as predictions and ground truth use the
same values.
All columns except <cite>id</cite> may contain whitespace-separated values as necessary.
The confidence probabilities and bounds values are optional.</p>
<ul>
<li><p>Example Ground Truth CSV line for only id and label:</p>
<blockquote>
<div><p>mnist-test-00001,7</p>
</div></blockquote>
</li>
<li><p>Example Ground Truth CSV line for id and a single label and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00000163,n03733805,84 0 433 275</p>
</div></blockquote>
</li>
<li><p>Example Ground Truth CSV line for id and multiple (2) label and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00004833,n03733805 n03733805,85 93 350 355 301 306 421 428</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for only id and label:</p>
<blockquote>
<div><p>mnist-test-00001,7</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and a single label, confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00000163,n03733805,.9,84 0 433 278</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and a single label, no confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00000163,n03733805,,84 0 433 278</p>
</div></blockquote>
</li>
<li><p>Example Prediction CSV line for id and multiple (3) label, confidence, and bounds:</p>
<blockquote>
<div><p>ILSVRC2012_val_00004833,n03733805 n03733805 n03733805,.9 .8 .8,85 93 350 355 301 306 421 428 0 5 469 373</p>
</div></blockquote>
</li>
<li><p>Example of <em>incorrect</em> Prediction CSV line where addition bounds and confidence will be ignored due to only 1 label:</p>
<blockquote>
<div><p>ILSVRC2012_val_00004833,n03733805,.9 .8 .8,85 93 350 355 301 306 421 428 0 5 469 373</p>
</div></blockquote>
</li>
</ul>
<p><strong>JSON Format</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;recordId&quot;</span><span class="p">:</span> <span class="s2">&quot;id_value&quot;</span><span class="p">,</span>
      <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;label1_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;confidence1_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;b3&quot;</span><span class="p">,</span> <span class="s2">&quot;b4&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;label2_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;confidence2_value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;b3&quot;</span><span class="p">,</span> <span class="s2">&quot;b4&quot;</span><span class="p">]</span>
         <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example Ground Truth JSON with one data record with id and label:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;recordId&quot;</span><span class="p">:</span> <span class="s2">&quot;mnist-train-00001&quot;</span><span class="p">,</span>
      <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example Ground Truth JSON for id and multiple (2) label and bounds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;recordId&quot;</span><span class="p">:</span> <span class="s2">&quot;ILSVRC2012_val_00048981&quot;</span><span class="p">,</span>
      <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;n03995372&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;85&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;499&quot;</span><span class="p">,</span><span class="s2">&quot;272&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;n03481172&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;131&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;499&quot;</span><span class="p">,</span><span class="s2">&quot;254&quot;</span><span class="p">]</span>
         <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example Prediction JSON line for id and multiple (2) label, confidence, and bounds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;recordId&quot;</span><span class="p">:</span> <span class="s2">&quot;ILSVRC2012_val_00048981&quot;</span><span class="p">,</span>
      <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;n03995372&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;.91&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;85&quot;</span><span class="p">,</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;499&quot;</span><span class="p">,</span><span class="s2">&quot;272&quot;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;n03481172&quot;</span><span class="p">,</span>
          <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="s2">&quot;.8&quot;</span><span class="p">,</span>
          <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;131&quot;</span><span class="p">,</span><span class="s2">&quot;0&quot;</span><span class="p">,</span><span class="s2">&quot;499&quot;</span><span class="p">,</span><span class="s2">&quot;254&quot;</span><span class="p">]</span>
         <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>JSON file utilizing the MistkDataRecordList format where “items” is a list of MistkDataRecord objects.
The MistkDataRecord requires a “recordId” String field for the id and a “values” list field where
each “value” is a dictionary for label, confidence, and bounds.</p>
</section>
<section id="example-model-with-csv-output">
<h3>Example Model with CSV Output<a class="headerlink" href="#example-model-with-csv-output" title="Permalink to this heading"></a></h3>
<p>The following example code implements a logistic regression algorithm
from scikit-learn with the MISTK model interface which operates on a common public dataset:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">##############################################################################</span>
<span class="linenos">  2</span><span class="c1">#</span>
<span class="linenos">  3</span><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  4</span><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  5</span><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  6</span><span class="c1">#    (at your option) any later version.</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  9</span><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 10</span><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 11</span><span class="c1">#    GNU General Public License for more details.</span>
<span class="linenos"> 12</span><span class="c1">#</span>
<span class="linenos"> 13</span><span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 14</span><span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 15</span><span class="c1">#</span>
<span class="linenos"> 16</span><span class="c1">##############################################################################</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 20</span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="linenos"> 21</span><span class="kn">import</span> <span class="nn">pandas</span>
<span class="linenos"> 22</span><span class="kn">import</span> <span class="nn">base64</span>
<span class="linenos"> 23</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">mistk.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span><span class="c1"># derive this model from AbstractModel</span>
<span class="linenos"> 30</span><span class="k">class</span> <span class="nc">ScikitLearnLogisticRegressionModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="linenos"> 31</span>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 32</span>      <span class="c1"># remember to call the base __init__</span>
<span class="linenos"> 33</span>      <span class="n">AbstractModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span>      <span class="c1"># initialize our model variables</span>
<span class="linenos"> 36</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 37</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 38</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 39</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 40</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 41</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 42</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 43</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 44</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 45</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="s1">&#39;scikit-logistic-regression-model.bin&#39;</span>
<span class="linenos"> 46</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>  <span class="k">def</span> <span class="nf">do_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">props</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hparams</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 49</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">props</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 50</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 51</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="n">objectives</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">)</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span>      <span class="k">if</span> <span class="s1">&#39;model_file_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 56</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;model_file_name&#39;</span><span class="p">]</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span>  <span class="k">def</span> <span class="nf">do_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 59</span>      <span class="c1"># check for and load training data and/or test data</span>
<span class="linenos"> 60</span>      <span class="c1"># NOTE this model is coded to this particular (arbitrary)</span>
<span class="linenos"> 61</span>      <span class="c1"># dataset format</span>
<span class="linenos"> 62</span>      <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos"> 63</span>          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No datasets provided&#39;</span><span class="p">)</span>
<span class="linenos"> 64</span>      <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos"> 65</span>          <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="linenos"> 66</span>          <span class="n">data_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/data.csv&#39;</span><span class="p">)</span>
<span class="linenos"> 67</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 68</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 69</span>      <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos"> 70</span>          <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
<span class="linenos"> 71</span>          <span class="n">data_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/data.csv&#39;</span><span class="p">)</span>
<span class="linenos"> 72</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>  <span class="k">def</span> <span class="nf">do_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 75</span>      <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
<span class="linenos"> 76</span>          <span class="c1"># if we got a path to a saved model then load it</span>
<span class="linenos"> 77</span>          <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
<span class="linenos"> 78</span>          <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="linenos"> 79</span>              <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading model &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span>              <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos"> 82</span>                  <span class="c1"># we decided to use python pickle to save and load</span>
<span class="linenos"> 83</span>                  <span class="c1"># model checkpoints in this model, but other models</span>
<span class="linenos"> 84</span>                  <span class="c1"># are free to use any format they desire</span>
<span class="linenos"> 85</span>                  <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="linenos"> 86</span>              <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">)</span>
<span class="linenos"> 87</span>          <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 88</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="linenos"> 89</span>      <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 90</span>          <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>  <span class="k">def</span> <span class="nf">do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 93</span>      <span class="c1"># train with our previously loaded data</span>
<span class="linenos"> 94</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span><span class="p">)</span>
<span class="linenos"> 95</span>      <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_fit&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">)})</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>  <span class="k">def</span> <span class="nf">do_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="linenos"> 98</span>      <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
<span class="linenos"> 99</span>      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model to &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos">100</span>
<span class="linenos">101</span>      <span class="c1"># just saving a simple &#39;pickled&#39; model to disk</span>
<span class="linenos">102</span>      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">103</span>          <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">))</span>
<span class="linenos">104</span>
<span class="linenos">105</span>  <span class="k">def</span> <span class="nf">do_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">106</span>      <span class="c1"># This is a future capability that is not supported at this time</span>
<span class="linenos">107</span>      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">108</span>
<span class="linenos">109</span>  <span class="k">def</span> <span class="nf">do_resume_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">110</span>      <span class="c1"># This is a future capability that is not supported at this time</span>
<span class="linenos">111</span>      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">112</span>
<span class="linenos">113</span>  <span class="k">def</span> <span class="nf">do_resume_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">114</span>      <span class="c1"># This is a future capability that is not supported at this time</span>
<span class="linenos">115</span>      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">116</span>
<span class="linenos">117</span>  <span class="k">def</span> <span class="nf">do_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">118</span>      <span class="c1"># predict with our previously loaded data</span>
<span class="linenos">119</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)</span>
<span class="linenos">120</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">121</span>      <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_predicted&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)})</span>
<span class="linenos">122</span>
<span class="linenos">123</span>  <span class="k">def</span> <span class="nf">do_save_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
<span class="linenos">124</span>      <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
<span class="linenos">125</span>      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving predictions to &quot;</span> <span class="o">+</span> <span class="n">dataPath</span><span class="p">)</span>
<span class="linenos">126</span>
<span class="linenos">127</span>      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">128</span>          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="linenos">129</span>              <span class="c1"># write out a results csv that can be evaluated</span>
<span class="linenos">130</span>              <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">131</span>                    <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">132</span>
<span class="linenos">133</span>  <span class="k">def</span> <span class="nf">do_stream_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">134</span>      <span class="c1"># stream prediction takes a dict of id&#39;s to base64 encoded data</span>
<span class="linenos">135</span>      <span class="c1"># and returns a dict of id&#39;s to predicted values</span>
<span class="linenos">136</span>      <span class="c1"># this model expects the underlying encoded data to be a JSON list of feature values</span>
<span class="linenos">137</span>      <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">138</span>      <span class="n">detailed_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">139</span>      <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">140</span>          <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicting class for key &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
<span class="linenos">141</span>          <span class="n">data_row</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="linenos">142</span>          <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">data_row</span><span class="p">])</span>
<span class="linenos">143</span>          <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">144</span>          <span class="n">detailed_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">([</span><span class="n">data_row</span><span class="p">])</span>
<span class="linenos">145</span>          
<span class="linenos">146</span>      <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
<span class="linenos">147</span>          <span class="c1"># additional details for predictions</span>
<span class="linenos">148</span>          <span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_stream_predict_details</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">detailed_data</span><span class="p">)</span>
<span class="linenos">149</span>              
<span class="linenos">150</span>      <span class="k">return</span> <span class="n">predictions</span>
<span class="linenos">151</span>
<span class="linenos">152</span>  <span class="k">def</span> <span class="nf">_format_stream_predict_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">prediction_details</span><span class="p">):</span>
<span class="linenos">153</span><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">154</span><span class="sd">      Format stream predict details in the form of NGX Markdown </span>
<span class="linenos">155</span><span class="sd">      :param predictions: predictions for each streaming image</span>
<span class="linenos">156</span><span class="sd">      :param prediction_details: prediction probabilities for each streaming image</span>
<span class="linenos">157</span><span class="sd">      &quot;&quot;&quot;</span>
<span class="linenos">158</span>      
<span class="linenos">159</span>      <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;#Logistic Regression Model Results&quot;</span>
<span class="linenos">160</span>      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">These section contains details about the **Logistic Regression Model Results**.&lt;br/&gt;&lt;br/&gt;&quot;</span>
<span class="linenos">161</span>      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br/&gt;&lt;br/&gt;&quot;</span>
<span class="linenos">162</span>      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Trained Model Streaming Results&quot;</span>
<span class="linenos">163</span>      <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br/&gt;&lt;br/&gt;&quot;</span>
<span class="linenos">164</span>        
<span class="linenos">165</span>      <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="n">prediction_details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">166</span>          <span class="n">details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#### For image </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> with prediction of </span><span class="si">{</span><span class="n">predictions</span><span class="p">[</span><span class="n">image</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">167</span>          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">| Class        | Probability |&quot;</span>
<span class="linenos">168</span>          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| ------------- |:-------------:|&quot;</span>
<span class="linenos">169</span>          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">classes_</span><span class="p">)):</span> 
<span class="linenos">170</span>              <span class="n">details</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">        | </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> |&quot;</span>
<span class="linenos">171</span>          <span class="n">details</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<span class="linenos">172</span>
<span class="linenos">173</span>  <span class="k">def</span> <span class="nf">do_update_stream_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">174</span>      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;do_update_stream_properties called&#39;</span><span class="p">)</span>
<span class="linenos">175</span>      <span class="bp">self</span><span class="o">.</span><span class="n">_stream_props</span> <span class="o">=</span> <span class="n">props</span>
<span class="linenos">176</span>
<span class="linenos">177</span>  <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">178</span>      <span class="c1"># nothing to clean up for this model</span>
<span class="linenos">179</span>      <span class="k">pass</span>
<span class="linenos">180</span>  
<span class="linenos">181</span>  <span class="k">def</span> <span class="nf">do_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">182</span><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">183</span><span class="sd">      Executes/resumes the generate activity</span>
<span class="linenos">184</span><span class="sd">      This operation is currently not supported. </span>
<span class="linenos">185</span><span class="sd">      &quot;&quot;&quot;</span>
<span class="linenos">186</span>      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;generate&#39;&quot;</span>
<span class="linenos">187</span>      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">188</span>    
<span class="linenos">189</span>  <span class="k">def</span> <span class="nf">do_save_generations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
<span class="linenos">190</span><span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">191</span><span class="sd">      Saves the current generations to the location specified</span>
<span class="linenos">192</span><span class="sd">        </span>
<span class="linenos">193</span><span class="sd">      :param dataPath: The location on the local file system or distributed</span>
<span class="linenos">194</span><span class="sd">          file system where the generations will be saved</span>
<span class="linenos">195</span><span class="sd">      &quot;&quot;&quot;</span>
<span class="linenos">196</span>      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;save_generations&#39;&quot;</span>
<span class="linenos">197</span>      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">198</span>
<span class="linenos">199</span>  <span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="linenos">200</span>      <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
<span class="linenos">201</span>      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">202</span>          <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">203</span>      <span class="k">return</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</section>
<section id="example-model-with-json-output">
<h3>Example Model with JSON Output<a class="headerlink" href="#example-model-with-json-output" title="Permalink to this heading"></a></h3>
<p>The following example code implements a logistic regression algorithm
from scikit-learn with the MISTK model interface which operates on a common public dataset:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">##############################################################################</span>
<span class="linenos">  2</span><span class="c1">#</span>
<span class="linenos">  3</span><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  4</span><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  5</span><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  6</span><span class="c1">#    (at your option) any later version.</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  9</span><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 10</span><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 11</span><span class="c1">#    GNU General Public License for more details.</span>
<span class="linenos"> 12</span><span class="c1">#</span>
<span class="linenos"> 13</span><span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 14</span><span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 15</span><span class="c1">#</span>
<span class="linenos"> 16</span><span class="c1">##############################################################################</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="linenos"> 20</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="linenos"> 21</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="linenos"> 24</span><span class="kn">from</span> <span class="nn">logistic_regression_mistk.dataset_mnist</span> <span class="kn">import</span> <span class="n">load_training_data</span><span class="p">,</span> <span class="n">load_test_data</span>
<span class="linenos"> 25</span><span class="kn">from</span> <span class="nn">mistk.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>
<span class="linenos"> 26</span><span class="kn">from</span> <span class="nn">mistk.data</span> <span class="kn">import</span> <span class="n">MistkDataRecordList</span><span class="p">,</span> <span class="n">MistkDataRecord</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">mistk.data.utils</span> <span class="kn">import</span> <span class="n">serialize_model</span>
<span class="linenos"> 28</span><span class="kn">import</span> <span class="nn">mistk.log</span><span class="o">,</span> <span class="nn">logging</span>
<span class="linenos"> 29</span><span class="n">logger</span> <span class="o">=</span> <span class="n">mistk</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span><span class="k">class</span> <span class="nc">ScikitLearnLogisticRegressionModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="linenos"> 32</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 33</span>        <span class="n">AbstractModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 34</span>        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="linenos"> 35</span>        
<span class="linenos"> 36</span>        <span class="c1"># property attributes</span>
<span class="linenos"> 37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 39</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 40</span>        
<span class="linenos"> 41</span>        <span class="c1"># the model</span>
<span class="linenos"> 42</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 43</span>        
<span class="linenos"> 44</span>        <span class="c1"># the model init parameters</span>
<span class="linenos"> 45</span>        <span class="c1"># lbfgs solver chosen as default for speed over default liblinear</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="s1">&#39;lbfgs&#39;</span>  
<span class="linenos"> 47</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_penality</span> <span class="o">=</span> <span class="s1">&#39;l2&#39;</span>
<span class="linenos"> 48</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="linenos"> 49</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="linenos"> 50</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_intercept</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 51</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_class_weight</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 52</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="linenos"> 53</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 54</span>        
<span class="linenos"> 55</span>        <span class="c1"># the data</span>
<span class="linenos"> 56</span>        <span class="c1"># training images</span>
<span class="linenos"> 57</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 58</span>        <span class="c1"># training labels</span>
<span class="linenos"> 59</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 60</span>        <span class="c1"># training ids</span>
<span class="linenos"> 61</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_Z_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 62</span>        <span class="c1"># test images</span>
<span class="linenos"> 63</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 64</span>        <span class="c1"># test ids</span>
<span class="linenos"> 65</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_Z_test</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 66</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_data_loaded</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 67</span>        
<span class="linenos"> 68</span>        <span class="c1"># saved model file name</span>
<span class="linenos"> 69</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="s1">&#39;scikit-logistic-regression-model.bin&#39;</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span>        <span class="c1"># prediction attributes</span>
<span class="linenos"> 72</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 73</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 74</span>  
<span class="linenos"> 75</span>    <span class="k">def</span> <span class="nf">do_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">props</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hparams</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 76</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_initialize called&#39;</span><span class="p">)</span>
<span class="linenos"> 77</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">props</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 78</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 79</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="n">objectives</span>
<span class="linenos"> 80</span>        
<span class="linenos"> 81</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;properties: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">))</span>
<span class="linenos"> 82</span>        
<span class="linenos"> 83</span>        <span class="c1"># set model parameters from properties</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="s1">&#39;model_file_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 85</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;model_file_name&#39;</span><span class="p">]</span>
<span class="linenos"> 86</span>        <span class="k">if</span> <span class="s1">&#39;solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 87</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">]</span>
<span class="linenos"> 88</span>        <span class="k">if</span> <span class="s1">&#39;penality&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 89</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_penality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;penality&#39;</span><span class="p">]</span>
<span class="linenos"> 90</span>        <span class="k">if</span> <span class="s1">&#39;tol&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 91</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span>
<span class="linenos"> 92</span>        <span class="k">if</span> <span class="s1">&#39;C&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 93</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
<span class="linenos"> 94</span>        <span class="k">if</span> <span class="s1">&#39;fit_intercept&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 95</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_intercept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;fit_intercept&#39;</span><span class="p">]</span>   
<span class="linenos"> 96</span>        <span class="k">if</span> <span class="s1">&#39;class_weight&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 97</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_class_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;class_weight&#39;</span><span class="p">]</span>
<span class="linenos"> 98</span>        <span class="k">if</span> <span class="s1">&#39;max_iter&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 99</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span>    
<span class="linenos">100</span>        <span class="k">if</span> <span class="s1">&#39;n_jobs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos">101</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">]</span>
<span class="linenos">102</span>        
<span class="linenos">103</span>    <span class="k">def</span> <span class="nf">do_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span> 
<span class="linenos">104</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_load_data called&#39;</span><span class="p">)</span>
<span class="linenos">105</span>        <span class="c1"># Check for and load training data and/or test data</span>
<span class="linenos">106</span>        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos">107</span>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No datasets provided&#39;</span><span class="p">)</span>
<span class="linenos">108</span>        <span class="c1"># NOTE this model is coded to this particular MNIST dataset format</span>
<span class="linenos">109</span>        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos">110</span>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
<span class="linenos">111</span>            
<span class="linenos">112</span>            <span class="n">train_image</span><span class="p">,</span> <span class="n">train_label</span><span class="p">,</span> <span class="n">train_ids</span> <span class="o">=</span> <span class="n">load_training_data</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
<span class="linenos">113</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;training label size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_label</span><span class="p">)))</span>
<span class="linenos">114</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;training image size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_image</span><span class="p">)))</span>
<span class="linenos">115</span>
<span class="linenos">116</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span> <span class="o">=</span> <span class="n">train_image</span>
<span class="linenos">117</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span> <span class="o">=</span> <span class="n">train_label</span>
<span class="linenos">118</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_Z_train</span> <span class="o">=</span> <span class="n">train_ids</span>
<span class="linenos">119</span>            
<span class="linenos">120</span>        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos">121</span>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
<span class="linenos">122</span>            <span class="n">test_image</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_ids</span> <span class="o">=</span> <span class="n">load_test_data</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
<span class="linenos">123</span>            
<span class="linenos">124</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;testing image size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_image</span><span class="p">)))</span>
<span class="linenos">125</span>            
<span class="linenos">126</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span> <span class="o">=</span> <span class="n">test_image</span>
<span class="linenos">127</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_Z_test</span> <span class="o">=</span> <span class="n">test_ids</span>
<span class="linenos">128</span>
<span class="linenos">129</span>    <span class="k">def</span> <span class="nf">do_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">130</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_build_model called&#39;</span><span class="p">)</span>
<span class="linenos">131</span>        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
<span class="linenos">132</span>            <span class="c1"># if we got a path to a saved model then load it</span>
<span class="linenos">133</span>            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
<span class="linenos">134</span>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="linenos">135</span>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading model &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos">136</span>                
<span class="linenos">137</span>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">138</span>                    <span class="c1"># we decided to use python pickle to save and load</span>
<span class="linenos">139</span>                    <span class="c1"># model checkpoints in this model, but other models</span>
<span class="linenos">140</span>                    <span class="c1"># are free to use any format they desire</span>
<span class="linenos">141</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="linenos">142</span>                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">)</span>
<span class="linenos">143</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">144</span>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building model&quot;</span><span class="p">)</span>
<span class="linenos">145</span>                <span class="c1"># the model initialization w/ parameters</span>
<span class="linenos">146</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_penality</span><span class="p">,</span>
<span class="linenos">147</span>                                                <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span>
<span class="linenos">148</span>                                                <span class="n">fit_intercept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_intercept</span><span class="p">,</span> <span class="n">class_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_weight</span><span class="p">,</span>
<span class="linenos">149</span>                                                <span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">)</span>
<span class="linenos">150</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">151</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building model&quot;</span><span class="p">)</span>           
<span class="linenos">152</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_penality</span><span class="p">,</span>
<span class="linenos">153</span>                                                <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tolerance</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span>
<span class="linenos">154</span>                                                <span class="n">fit_intercept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_intercept</span><span class="p">,</span> <span class="n">class_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_weight</span><span class="p">,</span>
<span class="linenos">155</span>                                                <span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">)</span>
<span class="linenos">156</span>
<span class="linenos">157</span>    <span class="k">def</span> <span class="nf">do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">158</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;do_train called&quot;</span><span class="p">)</span>
<span class="linenos">159</span>        <span class="c1"># train with our previously loaded data</span>
<span class="linenos">160</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y_train</span><span class="p">)</span>
<span class="linenos">161</span>        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_fit&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_train</span><span class="p">)})</span>
<span class="linenos">162</span>    
<span class="linenos">163</span>    <span class="k">def</span> <span class="nf">do_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="linenos">164</span>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_file_name</span><span class="p">)</span>
<span class="linenos">165</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model to &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos">166</span>        
<span class="linenos">167</span>        <span class="c1"># just saving a simple &#39;pickled&#39; model to disk</span>
<span class="linenos">168</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">169</span>            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="p">))</span>
<span class="linenos">170</span>            
<span class="linenos">171</span>    <span class="k">def</span> <span class="nf">do_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">172</span>        <span class="c1"># this model doesn&#39;t support &#39;pause&#39;</span>
<span class="linenos">173</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">174</span>
<span class="linenos">175</span>    <span class="k">def</span> <span class="nf">do_resume_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">176</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">177</span>    
<span class="linenos">178</span>    <span class="k">def</span> <span class="nf">do_resume_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">179</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">180</span>    
<span class="linenos">181</span>    <span class="k">def</span> <span class="nf">do_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">182</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;do_predict called&quot;</span><span class="p">)</span>
<span class="linenos">183</span>        <span class="c1"># predict with our previously loaded data</span>
<span class="linenos">184</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)</span>
<span class="linenos">185</span>
<span class="linenos">186</span>        <span class="c1"># get probability associated with only the predicted value</span>
<span class="linenos">187</span>        <span class="n">class_probs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="n">pred_conf</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">189</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_probs</span><span class="p">)):</span>
<span class="linenos">190</span>            <span class="n">pred_conf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_probs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
<span class="linenos">191</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pred_conf</span><span class="p">)</span>
<span class="linenos">192</span>        
<span class="linenos">193</span>        <span class="c1"># alert sample predicted size</span>
<span class="linenos">194</span>        <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;samples_predicted&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_test</span><span class="p">)})</span>
<span class="linenos">195</span>    
<span class="linenos">196</span>    <span class="k">def</span> <span class="nf">do_save_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
<span class="linenos">197</span>        <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s2">&quot;predictions.json&quot;</span><span class="p">)</span>
<span class="linenos">198</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving predictions to &quot;</span> <span class="o">+</span> <span class="n">dataPath</span><span class="p">)</span>
<span class="linenos">199</span>        
<span class="linenos">200</span>        <span class="n">recordList</span> <span class="o">=</span> <span class="n">MistkDataRecordList</span><span class="p">()</span>
<span class="linenos">201</span>        <span class="n">recordList</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">202</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="linenos">203</span>            <span class="n">record</span> <span class="o">=</span> <span class="n">MistkDataRecord</span><span class="p">(</span><span class="n">record_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Z_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">204</span>            <span class="n">recordValue</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">205</span>            <span class="n">recordValue</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">206</span>            <span class="n">recordValue</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos">207</span>            <span class="n">record</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">recordValue</span><span class="p">]</span>
<span class="linenos">208</span>            <span class="n">recordList</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<span class="linenos">209</span>        <span class="c1"># write out a results json that can be evaluated</span>
<span class="linenos">210</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
<span class="linenos">211</span>            <span class="n">pred_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">serialize_model</span><span class="p">(</span><span class="n">recordList</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>  
<span class="linenos">212</span>        
<span class="linenos">213</span>                
<span class="linenos">214</span>    <span class="k">def</span> <span class="nf">do_stream_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">215</span>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">216</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">217</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicting class for key &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
<span class="linenos">218</span>            <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="linenos">219</span>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicting: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>
<span class="linenos">220</span>            <span class="n">predictions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">221</span>        <span class="k">return</span> <span class="n">predictions</span>
<span class="linenos">222</span>
<span class="linenos">223</span>    <span class="k">def</span> <span class="nf">do_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">224</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">225</span><span class="sd">        Executes/resumes the generate activity</span>
<span class="linenos">226</span><span class="sd">        This operation is currently not supported. </span>
<span class="linenos">227</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">228</span>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;generate&#39;&quot;</span>
<span class="linenos">229</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">230</span>    
<span class="linenos">231</span>    <span class="k">def</span> <span class="nf">do_save_generations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
<span class="linenos">232</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">233</span><span class="sd">        Saves the current generations to the location specified</span>
<span class="linenos">234</span><span class="sd">        </span>
<span class="linenos">235</span><span class="sd">        :param dataPath: The location on the local file system or distributed </span>
<span class="linenos">236</span><span class="sd">            file system where the generations will be saved</span>
<span class="linenos">237</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">238</span>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;this model doesn&#39;t support &#39;save_generations&#39;&quot;</span>
<span class="linenos">239</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">240</span>
<span class="linenos">241</span>
<span class="linenos">242</span>    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">243</span>        <span class="k">pass</span>
<span class="linenos">244</span>
<span class="linenos">245</span>    <span class="k">def</span> <span class="nf">do_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">246</span>        <span class="k">pass</span>
<span class="linenos">247</span>
</pre></div>
</div>
</section>
<section id="streaming-predictions-source">
<h3>Streaming Predictions Source<a class="headerlink" href="#streaming-predictions-source" title="Permalink to this heading"></a></h3>
<p>Model predictions done within the <strong>do_stream_predict_source</strong> method need to be added to the predictions queue
by using the <cite>update_source_predictions</cite> method provided by the AbstractModel. The streaming response via the
MISTK service will use this queue to chunk data for the response. If the source provided has no defined end
(e.g. a webcam) then the processing of the data should be within a while loop using <cite>self._model_streaming</cite>.
When a cancel operation occurs, the <cite>self._model_streaming</cite> variable will be set to false to allow the model
to know when to stop running predictions. The cancel operation is executed via the <cite>/streamPredict/source/cancel</cite>
endpoint of the MISTK service.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>    <span class="k">def</span> <span class="nf">do_stream_predict_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 2</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;do_stream_predict_source called&quot;</span><span class="p">)</span>
<span class="linenos"> 3</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 4</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;props: </span><span class="si">{</span><span class="n">props</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos"> 5</span>        
<span class="linenos"> 6</span>        <span class="c1"># load in source data here</span>
<span class="linenos"> 7</span>        
<span class="linenos"> 8</span>        <span class="c1"># continuous streaming source</span>
<span class="linenos"> 9</span>        <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_streaming</span><span class="p">):</span>
<span class="linenos">10</span>            
<span class="linenos">11</span>            <span class="c1"># get next data from streaming source here</span>
<span class="linenos">12</span>            
<span class="linenos">13</span>            
<span class="linenos">14</span>            <span class="c1"># do your prediction using source data here</span>
<span class="linenos">15</span>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">16</span>            
<span class="linenos">17</span>            <span class="c1"># update predictions for service</span>
<span class="linenos">18</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;streaming prediction...&#39;</span><span class="p">)</span>
<span class="linenos">19</span>            <span class="bp">self</span><span class="o">.</span><span class="n">update_source_predictions</span><span class="p">({</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;n03733805&quot;</span><span class="p">:</span> <span class="s2">&quot;.2,103 0 279 472&quot;</span><span class="p">}})</span>
<span class="linenos">20</span>
</pre></div>
</div>
</section>
<section id="transfer-learning">
<h3>Transfer learning<a class="headerlink" href="#transfer-learning" title="Permalink to this heading"></a></h3>
<p>Model support of transfer learning is independent to each model implementation.
Model developers that use the MISTK library need to incorporate their implementation
features for transfer learning into their build_model and train methods. The PyTorch
implementation below builds their model with specific configurations when performing
transfer learning. The highlighted lines are relevant lines for transfer learning
in this PyTorch implementation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">##############################################################################</span>
<span class="linenos">  2</span><span class="c1">#</span>
<span class="linenos">  3</span><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  4</span><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  5</span><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  6</span><span class="c1">#    (at your option) any later version.</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  9</span><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 10</span><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 11</span><span class="c1">#    GNU General Public License for more details.</span>
<span class="linenos"> 12</span><span class="c1">#</span>
<span class="linenos"> 13</span><span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 14</span><span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 15</span><span class="c1">#</span>
<span class="linenos"> 16</span><span class="c1">##############################################################################</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="linenos"> 20</span><span class="kn">import</span> <span class="nn">torch</span>
<span class="linenos"> 21</span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="linenos"> 22</span><span class="kn">import</span> <span class="nn">torch.optim</span>
<span class="linenos"> 23</span><span class="kn">import</span> <span class="nn">torch.nn</span>
<span class="linenos"> 24</span><span class="kn">import</span> <span class="nn">torch.autograd</span>
<span class="linenos"> 25</span><span class="kn">import</span> <span class="nn">torch.utils.data</span>
<span class="linenos"> 26</span><span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">mistk.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">.folder</span> <span class="kn">import</span> <span class="n">ImageFolder</span>
<span class="linenos"> 30</span><span class="kn">from</span> <span class="nn">.stream</span> <span class="kn">import</span> <span class="n">ImageStream</span>
<span class="linenos"> 31</span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">models</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="k">class</span> <span class="nc">PyTorchImageNetModel</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="linenos"> 34</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 35</span>        <span class="n">AbstractModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 36</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 38</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 39</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 40</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 41</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 42</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 43</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 44</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 45</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 47</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
<span class="linenos"> 50</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="linenos"> 51</span>        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="linenos"> 52</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Completed PytorchImageNetModel construction&#39;</span><span class="p">)</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span>    <span class="k">def</span> <span class="nf">do_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">props</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hparams</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 55</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_initialize called in pytorch model&#39;</span><span class="p">)</span>
<span class="linenos"> 56</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="n">props</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 57</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span> <span class="o">=</span> <span class="n">hparams</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos"> 58</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span> <span class="o">=</span> <span class="n">objectives</span>
<span class="linenos"> 59</span>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">)</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span>    <span class="k">def</span> <span class="nf">do_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="hll"><span class="linenos"> 62</span>        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
</span><span class="hll"><span class="linenos"> 63</span>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No datasets provided&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 64</span>
</span><span class="hll"><span class="linenos"> 65</span>        <span class="k">if</span> <span class="s1">&#39;train&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
</span><span class="hll"><span class="linenos"> 66</span>            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span>
</span><span class="hll"><span class="linenos"> 67</span>            <span class="n">tr_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;ILSVRC/Data/CLS-LOC/train&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 68</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tr_data_path</span><span class="p">):</span>
</span><span class="hll"><span class="linenos"> 69</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looks like this is NOT an imagenet training dataset&#39;</span><span class="p">)</span>
</span><span class="linenos"> 70</span>                <span class="n">tr_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="linenos"> 71</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_train_data_loader</span><span class="p">(</span><span class="n">tr_data_path</span><span class="p">)</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span>        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">dataset_map</span><span class="p">:</span>
<span class="linenos"> 74</span>            <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset_map</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
<span class="linenos"> 75</span>            <span class="n">te_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;ILSVRC/Data/CLS-LOC/val&quot;</span><span class="p">)</span>
<span class="linenos"> 76</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">te_data_path</span><span class="p">):</span>
<span class="linenos"> 77</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looks like this is NOT an imagenet testing dataset&#39;</span><span class="p">)</span>
<span class="linenos"> 78</span>                <span class="n">te_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">)</span>
<span class="hll"><span class="linenos"> 79</span>                <span class="n">labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;ground_truth.csv&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 80</span>            <span class="k">else</span><span class="p">:</span>
</span><span class="hll"><span class="linenos"> 81</span>                <span class="n">labels_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;LOC_val_solution.csv&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos"> 82</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_data_loader</span><span class="p">(</span><span class="n">te_data_path</span><span class="p">,</span>
</span><span class="linenos"> 83</span>                                                                <span class="n">labels_file</span><span class="p">)</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span>    <span class="k">def</span> <span class="nf">do_build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 86</span>        <span class="n">arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="s1">&#39;densenet161&#39;</span><span class="p">)</span>
<span class="linenos"> 87</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading new model for &quot;</span> <span class="o">+</span> <span class="n">arch</span><span class="p">)</span>
<span class="linenos"> 88</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">arch</span><span class="p">]()</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="s1">&#39;checkpoint_load_file&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos"> 93</span>            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;checkpoint_load_file&#39;</span><span class="p">])</span>
<span class="linenos"> 94</span>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
<span class="linenos"> 95</span>                <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 96</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 97</span>                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Specified checkpoint file is not valid, ignoring&#39;</span><span class="p">)</span>
<span class="linenos"> 98</span>                <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 99</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">100</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No checkpoint file specified&#39;</span><span class="p">)</span>
<span class="linenos">101</span>            <span class="n">have_checkpoint</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">102</span>
<span class="linenos">103</span>        <span class="k">if</span> <span class="n">have_checkpoint</span><span class="p">:</span>
<span class="linenos">104</span>            <span class="c1"># imagenet has 1000 labels and that is the assumed default</span>
<span class="linenos">105</span>            <span class="n">number_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_labels&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="linenos">106</span>            <span class="k">if</span> <span class="n">number_labels</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
<span class="linenos">107</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting number of labels to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_labels</span><span class="p">))</span>
<span class="linenos">108</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">set_classifier</span><span class="p">(</span><span class="n">number_labels</span><span class="p">)</span>
<span class="linenos">109</span>
<span class="linenos">110</span>            <span class="c1"># Need to set this before the checkpoint is loaded</span>
<span class="linenos">111</span>            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alexnet&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vgg&#39;</span><span class="p">):</span>
<span class="linenos">112</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="linenos">113</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="linenos">114</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">115</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="linenos">116</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished loading model parallelization features&#39;</span><span class="p">)</span>
<span class="linenos">117</span>
<span class="linenos">118</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading model checkpoint from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">checkpoint_path</span><span class="p">)</span>
<span class="linenos">119</span>            <span class="n">checkpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_state_file</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>
<span class="linenos">120</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
<span class="linenos">121</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>
<span class="linenos">122</span>
<span class="linenos">123</span>            <span class="k">if</span> <span class="n">number_labels</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
<span class="linenos">124</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Assuming optimizer was used for transfer learning&quot;</span><span class="p">)</span>
<span class="linenos">125</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_classifier</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
<span class="linenos">126</span>                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
<span class="linenos">127</span>                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
<span class="linenos">128</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">129</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
<span class="linenos">130</span>                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
<span class="linenos">131</span>                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
<span class="linenos">132</span>
<span class="linenos">133</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading optimizer settings from checkpoint&#39;</span><span class="p">)</span>
<span class="linenos">134</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
<span class="linenos">135</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">136</span>            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="s1">&#39;model_load_file&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
<span class="linenos">137</span>                <span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="s1">&#39;model_load_file&#39;</span><span class="p">])</span>
<span class="linenos">138</span>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">remote_path</span><span class="p">):</span>
<span class="linenos">139</span>                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading model load file from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remote_path</span><span class="p">)</span>
<span class="linenos">140</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_state_file</span><span class="p">(</span><span class="n">remote_path</span><span class="p">))</span>
<span class="linenos">141</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">142</span>                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Specified model load file is not valid, ignoring&#39;</span><span class="p">)</span>
<span class="linenos">143</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">144</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No model load file specified&#39;</span><span class="p">)</span>
<span class="linenos">145</span>
<span class="linenos">146</span>            <span class="k">if</span> <span class="s1">&#39;transfer_learning&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span><span class="p">:</span>
<span class="linenos">147</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Freezing hidden layers for transfer learning&#39;</span><span class="p">)</span>
<span class="linenos">148</span>                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<span class="linenos">149</span>                    <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">150</span>                <span class="c1"># imagenet has 1000 labels and that is the assumed default</span>
<span class="linenos">151</span>                <span class="n">number_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_labels&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="linenos">152</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting number of labels to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_labels</span><span class="p">))</span>
<span class="linenos">153</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">set_classifier</span><span class="p">(</span><span class="n">number_labels</span><span class="p">)</span>
<span class="linenos">154</span>
<span class="linenos">155</span>            <span class="c1"># This will need to be loaded after the model load</span>
<span class="linenos">156</span>            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alexnet&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;vgg&#39;</span><span class="p">):</span>
<span class="linenos">157</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
<span class="linenos">158</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="linenos">159</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">160</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="linenos">161</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished loading model parallelization features&#39;</span><span class="p">)</span>
<span class="linenos">162</span>
<span class="linenos">163</span>            <span class="k">if</span> <span class="s1">&#39;transfer_learning&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objectives</span><span class="p">:</span>
<span class="linenos">164</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_classifier</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
<span class="linenos">165</span>                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
<span class="linenos">166</span>                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
<span class="linenos">167</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">168</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span><span class="p">,</span>
<span class="linenos">169</span>                                                  <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
<span class="linenos">170</span>                                                  <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
<span class="linenos">171</span>
<span class="linenos">172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="linenos">173</span>
<span class="linenos">174</span>        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">:</span>
<span class="linenos">175</span>            <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
<span class="linenos">176</span>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">classes_path</span><span class="p">):</span>
<span class="linenos">177</span>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">178</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
<span class="linenos">179</span>
<span class="linenos">180</span>
<span class="linenos">181</span>    <span class="k">def</span> <span class="nf">do_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="linenos">182</span>        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checkpoint_save_file&#39;</span><span class="p">,</span> <span class="s1">&#39;checkpoint.pth&#39;</span><span class="p">)</span>
<span class="linenos">183</span>        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="linenos">184</span>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving model checkpoint to &quot;</span> <span class="o">+</span> <span class="n">checkpoint_path</span><span class="p">)</span>
<span class="linenos">185</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">186</span>            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
<span class="linenos">187</span>                    <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">188</span>                    <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<span class="linenos">189</span>                    <span class="s1">&#39;optimizer&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<span class="linenos">190</span>                <span class="p">},</span> <span class="n">writer</span><span class="p">)</span>
<span class="linenos">191</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">:</span>
<span class="linenos">192</span>            <span class="n">classes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">)</span>
<span class="linenos">193</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">classes_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">194</span>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">))</span>
<span class="linenos">195</span>
<span class="linenos">196</span>    <span class="k">def</span> <span class="nf">do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">197</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting training at epoch </span><span class="si">%s</span><span class="s1"> until epoch </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="s1">&#39;90&#39;</span><span class="p">))))</span>
<span class="linenos">198</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="linenos">199</span>        <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_epoch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epochs&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">)):</span>
<span class="linenos">200</span>            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_learning_rate</span><span class="p">()</span>
<span class="linenos">201</span>
<span class="linenos">202</span>            <span class="n">losses</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>
<span class="linenos">203</span>            <span class="n">top1</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>
<span class="linenos">204</span>            <span class="n">top5</span> <span class="o">=</span> <span class="n">AverageMeter</span><span class="p">()</span>
<span class="linenos">205</span>
<span class="linenos">206</span>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">):</span>
<span class="linenos">207</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="linenos">208</span>
<span class="linenos">209</span>                <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="k">async</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">210</span>                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="k">async</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">211</span>                <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="linenos">212</span>                <span class="n">target_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="linenos">213</span>
<span class="linenos">214</span>                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>
<span class="linenos">215</span>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target_var</span><span class="p">)</span>
<span class="linenos">216</span>
<span class="linenos">217</span>                <span class="n">acc1</span><span class="p">,</span> <span class="n">acc5</span> <span class="o">=</span> <span class="n">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target_var</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="linenos">218</span>                <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">219</span>                <span class="n">top1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">220</span>                <span class="n">top5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acc5</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_var</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos">221</span>
<span class="linenos">222</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<span class="linenos">223</span>                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="linenos">224</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="linenos">225</span>
<span class="linenos">226</span>                <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data_loader</span><span class="p">)</span>
<span class="linenos">227</span>                <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">,</span> <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
<span class="linenos">228</span>                                   <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>
<span class="linenos">229</span>
<span class="linenos">230</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Epoch: [</span><span class="si">%i</span><span class="s1">][</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>
<span class="linenos">231</span>
<span class="linenos">232</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<span class="linenos">233</span>                  <span class="s1">&#39;Loss {loss.val:</span><span class="si">%.4f</span><span class="s1">} ({loss.avg:</span><span class="si">%.4f</span><span class="s1">})</span><span class="se">\t</span><span class="s1">&#39;</span>
<span class="linenos">234</span>                  <span class="s1">&#39;Acc@1 {top1.val:</span><span class="si">%.3f</span><span class="s1">} ({top1.avg:</span><span class="si">%.3f</span><span class="s1">})</span><span class="se">\t</span><span class="s1">&#39;</span>
<span class="linenos">235</span>                  <span class="s1">&#39;Acc@5 {top5.val:</span><span class="si">%.3f</span><span class="s1">} ({top5.avg:</span><span class="si">%.3f</span><span class="s1">})&#39;</span><span class="p">,</span>
<span class="linenos">236</span>                      <span class="n">losses</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">losses</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">top1</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">top1</span><span class="o">.</span><span class="n">avg</span><span class="p">,</span> <span class="n">top5</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">top5</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span>
<span class="linenos">237</span>
<span class="linenos">238</span>    <span class="k">def</span> <span class="nf">do_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">239</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="linenos">240</span>
<span class="linenos">241</span>    <span class="k">def</span> <span class="nf">do_resume_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">242</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="linenos">243</span>
<span class="linenos">244</span>    <span class="k">def</span> <span class="nf">do_resume_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">245</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="linenos">246</span>
<span class="linenos">247</span>    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">248</span>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<span class="linenos">249</span>
<span class="linenos">250</span>    <span class="k">def</span> <span class="nf">do_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">251</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting predictions&#39;</span><span class="p">)</span>
<span class="linenos">252</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="linenos">253</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">):</span>
<span class="linenos">254</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="linenos">255</span>
<span class="linenos">256</span>            <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">257</span>            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>
<span class="linenos">258</span>
<span class="linenos">259</span>            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">260</span>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
<span class="linenos">261</span>                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="linenos">262</span>                <span class="n">rowid</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
<span class="linenos">263</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="p">[</span><span class="n">rowid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">264</span>
<span class="linenos">265</span>            <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_data_loader</span><span class="p">)</span>
<span class="linenos">266</span>            <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>
<span class="linenos">267</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Test: [</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>
<span class="linenos">268</span>
<span class="linenos">269</span>    <span class="k">def</span> <span class="nf">do_stream_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">270</span>        <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_stream_data_loader</span><span class="p">(</span><span class="n">data_map</span><span class="p">)</span>
<span class="linenos">271</span>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">272</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="linenos">273</span>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
<span class="linenos">274</span>            <span class="n">input_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">volatile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">275</span>            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">(</span><span class="n">input_var</span><span class="p">)</span>
<span class="linenos">276</span>
<span class="linenos">277</span>            <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">278</span>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
<span class="linenos">279</span>                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Predicted class is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos">280</span>                <span class="n">predictions</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span><span class="p">[</span><span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_classes</span> <span class="k">else</span> <span class="n">pred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">281</span>
<span class="linenos">282</span>            <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
<span class="linenos">283</span>            <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">({</span><span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;total_iterations&quot;</span><span class="p">:</span> <span class="n">datalen</span><span class="p">})</span>
<span class="linenos">284</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Test: [</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datalen</span><span class="p">)</span>
<span class="linenos">285</span>
<span class="linenos">286</span>        <span class="k">return</span> <span class="n">predictions</span>
<span class="linenos">287</span>    
<span class="linenos">288</span>    <span class="k">def</span> <span class="nf">do_update_stream_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">289</span>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;do_update_stream_properties called&#39;</span><span class="p">)</span>
<span class="linenos">290</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_props</span> <span class="o">=</span> <span class="n">props</span>
<span class="linenos">291</span>
<span class="linenos">292</span>    <span class="k">def</span> <span class="nf">do_save_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataPath</span><span class="p">):</span>
<span class="linenos">293</span>        <span class="n">dataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
<span class="linenos">294</span>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving predictions to &quot;</span> <span class="o">+</span> <span class="n">dataPath</span><span class="p">)</span>
<span class="linenos">295</span>
<span class="linenos">296</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataPath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">297</span>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">298</span>                <span class="c1"># write out a results csv that can be evaluated by the ERE</span>
<span class="linenos">299</span>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_classes</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">300</span>
<span class="linenos">301</span>    <span class="k">def</span> <span class="nf">create_train_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="linenos">302</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading training dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
<span class="linenos">303</span>        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<span class="linenos">304</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="linenos">305</span>                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
<span class="linenos">306</span>                <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
<span class="linenos">307</span>                <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos">308</span>                <span class="n">normalize</span><span class="p">,]))</span>
<span class="linenos">309</span>        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos">310</span>                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">311</span>                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">312</span>        <span class="k">return</span> <span class="n">loader</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>
<span class="linenos">313</span>
<span class="linenos">314</span>    <span class="k">def</span> <span class="nf">do_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">315</span>        <span class="k">pass</span>
<span class="linenos">316</span>
<span class="linenos">317</span>    <span class="k">def</span> <span class="nf">create_stream_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_map</span><span class="p">):</span>
<span class="linenos">318</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loading stream dataset&#39;</span><span class="p">)</span>
<span class="linenos">319</span>        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<span class="linenos">320</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageStream</span><span class="p">(</span><span class="n">data_map</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="linenos">321</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="linenos">322</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
<span class="linenos">323</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos">324</span>                    <span class="n">normalize</span><span class="p">,]))</span>
<span class="linenos">325</span>        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos">326</span>                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">327</span>                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">328</span>        <span class="k">return</span> <span class="n">loader</span>
<span class="linenos">329</span>
<span class="linenos">330</span>    <span class="k">def</span> <span class="nf">create_test_data_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">ground_truth_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">331</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading test dataset from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
<span class="linenos">332</span>        <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
<span class="linenos">333</span>        <span class="k">if</span> <span class="n">ground_truth_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">334</span>            <span class="n">label_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">335</span>            <span class="n">path_to_label</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">336</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ground_truth_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">337</span>                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">338</span>                    <span class="n">cols</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="linenos">339</span>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ImageId&#39;</span><span class="p">):</span>
<span class="linenos">340</span>                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.JPEG&#39;</span><span class="p">)</span>
<span class="linenos">341</span>                        <span class="n">label</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">342</span>                        <span class="n">path_to_label</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
<span class="linenos">343</span>                        <span class="n">label_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
<span class="linenos">344</span>
<span class="linenos">345</span>            <span class="n">classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">label_set</span><span class="p">)</span>
<span class="linenos">346</span>
<span class="linenos">347</span>            <span class="n">label_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">348</span>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
<span class="linenos">349</span>                <span class="n">label_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
<span class="linenos">350</span>
<span class="linenos">351</span>            <span class="n">path_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">352</span>            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">path_to_label</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">353</span>                <span class="n">path_to_idx</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
<span class="linenos">354</span>
<span class="linenos">355</span>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="linenos">356</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="linenos">357</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
<span class="linenos">358</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos">359</span>                    <span class="n">normalize</span><span class="p">,]),</span> <span class="n">path_to_idx</span><span class="o">=</span><span class="n">path_to_idx</span><span class="p">)</span>
<span class="linenos">360</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">361</span>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">ImageFolder</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
<span class="linenos">362</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="linenos">363</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
<span class="linenos">364</span>                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="linenos">365</span>                    <span class="n">normalize</span><span class="p">,]))</span>
<span class="linenos">366</span>            <span class="n">classes</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">classes</span>
<span class="linenos">367</span>
<span class="linenos">368</span>        <span class="n">loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
<span class="linenos">369</span>                <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos">370</span>                <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_workers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">371</span>        <span class="k">return</span> <span class="n">loader</span><span class="p">,</span> <span class="n">classes</span>
<span class="linenos">372</span>
<span class="linenos">373</span>    <span class="k">def</span> <span class="nf">load_state_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="linenos">374</span>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="linenos">375</span>        <span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="linenos">376</span>        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading state file from &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="linenos">377</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
<span class="linenos">378</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">379</span>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="linenos">380</span>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
<span class="linenos">381</span>
<span class="linenos">382</span>    <span class="k">def</span> <span class="nf">adjust_learning_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">383</span>        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_rate</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_epoch</span> <span class="o">//</span> <span class="mi">30</span><span class="p">))</span>
<span class="linenos">384</span>        <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
<span class="linenos">385</span>            <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
<span class="linenos">386</span>
<span class="linenos">387</span>
<span class="linenos">388</span><span class="k">class</span> <span class="nc">AverageMeter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">389</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes and stores the average and current value&quot;&quot;&quot;</span>
<span class="linenos">390</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">391</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="linenos">392</span>
<span class="linenos">393</span>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">394</span>        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">395</span>        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">396</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">397</span>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">398</span>
<span class="linenos">399</span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos">400</span>        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
<span class="linenos">401</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">n</span>
<span class="linenos">402</span>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">n</span>
<span class="linenos">403</span>        <span class="bp">self</span><span class="o">.</span><span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
<span class="linenos">404</span>
<span class="linenos">405</span><span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)):</span>
<span class="linenos">406</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the accuracy over the k top predictions for the specified values of k&quot;&quot;&quot;</span>
<span class="linenos">407</span>    <span class="n">maxk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">topk</span><span class="p">)</span>
<span class="linenos">408</span>    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">409</span>
<span class="linenos">410</span>    <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">maxk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">411</span>    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
<span class="linenos">412</span>    <span class="n">correct</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
<span class="linenos">413</span>
<span class="linenos">414</span>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">415</span>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">topk</span><span class="p">:</span>
<span class="linenos">416</span>        <span class="n">correct_k</span> <span class="o">=</span> <span class="n">correct</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">417</span>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correct_k</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
<span class="linenos">418</span>    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>Model developers will need to specify in their model properties that they are performing
transfer learning when using this model for that purpose.</p>
</section>
<section id="ensemble-models">
<h3>Ensemble Models<a class="headerlink" href="#ensemble-models" title="Permalink to this heading"></a></h3>
<p>Model support for building ensemble models uses the <strong>do_build_ensemble(ensemble_path=None, model_paths: dict=None)</strong></p>
<p>Building of an ensemble model provides a way to ensemble individual models defined in the <strong>model_paths</strong>
parameter. The model paths dictionary is based on the model name (key) and the directory path (value)
for each model’s files. Below is a sample the ensembled model properties
dictionaries that can be passed to a model implementation’s ‘do_build_ensemble’ method.</p>
<p>Model Paths:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;model1&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/model1&quot;</span>
  <span class="s2">&quot;model2&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/model2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="data-transformation-interface">
<h2>Data Transformation Interface<a class="headerlink" href="#data-transformation-interface" title="Permalink to this heading"></a></h2>
<p>The MISTK API provides an interface for creating data transformation plugins. These
plugins run within docker containers similar to models. A MISTK data transform
implements the ‘mistk.transform.AbstractTransformPlugin’ abstract class. This class
provides a set of abstract methods that represent the data transform lifecycle and
must be implemented by the new data transform plugin. Ultimately, these methods form the core of
the web endpoint service that is made available for every data transform implementation.</p>
<dl class="simple">
<dt><strong>do_transform</strong> (inputDirs: list, outputDir: string, properties: dict)</dt><dd><p>Performs a data transformation using the data provided in the input directories
and stores the resulting dataset(s) in the output directory.</p>
<dl class="field-list simple">
<dt class="field-odd">param inputDirs<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of directory paths from which to load input datasets from.</p>
</dd>
<dt class="field-even">param outputDir<span class="colon">:</span></dt>
<dd class="field-even"><p>The directory path where the output dataset will be stored</p>
</dd>
<dt class="field-odd">param props<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dictionary of settings or configuration values that are passed
to the transformation.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<section id="the-transformation-state-machine">
<h3>The Transformation State Machine<a class="headerlink" href="#the-transformation-state-machine" title="Permalink to this heading"></a></h3>
<p>Data transformation plugin implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the data transform plugin methods
that may be called between them.</p>
<img alt="_images/transform_state_machine.png" src="_images/transform_state_machine.png" />
<p>A data transform plugin instance will automatically go to the Ready state if its
container instance successfully starts up. After completing a transformation, it
will return to the Ready state so that multiple transformations can be executed
using the same container instance.</p>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<p>The following example code implements a ground truth transform for an MNIST formatted dataset
with the MISTK data transformation interfacet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">##############################################################################</span>
<span class="linenos">  2</span><span class="c1">#</span>
<span class="linenos">  3</span><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  4</span><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  5</span><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  6</span><span class="c1">#    (at your option) any later version.</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  9</span><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 10</span><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 11</span><span class="c1">#    GNU General Public License for more details.</span>
<span class="linenos"> 12</span><span class="c1">#</span>
<span class="linenos"> 13</span><span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 14</span><span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 15</span><span class="c1">#</span>
<span class="linenos"> 16</span><span class="c1">##############################################################################</span>
<span class="linenos"> 17</span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">glob</span>
<span class="linenos"> 18</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 20</span><span class="kn">from</span> <span class="nn">mistk.transform.abstract_transform_plugin</span> <span class="kn">import</span> <span class="n">AbstractTransformPlugin</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="k">class</span> <span class="nc">ground_truth_transform</span><span class="p">(</span><span class="n">AbstractTransformPlugin</span><span class="p">):</span>
<span class="linenos"> 23</span>    
<span class="linenos"> 24</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 25</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 26</span><span class="sd">        Constructor</span>
<span class="linenos"> 27</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 28</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 29</span>    
<span class="linenos"> 30</span>    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 31</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 32</span><span class="sd">        Terminates the transform plugin</span>
<span class="linenos"> 33</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 34</span>        <span class="n">AbstractTransformPlugin</span><span class="o">.</span><span class="n">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 35</span>    
<span class="linenos"> 36</span>    <span class="k">def</span> <span class="nf">do_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputDirs</span><span class="p">,</span> <span class="n">outputDir</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
<span class="linenos"> 37</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 38</span><span class="sd">        Performs the transformation</span>
<span class="linenos"> 39</span><span class="sd">        </span>
<span class="linenos"> 40</span><span class="sd">        :param inputDirs: A list of input directories</span>
<span class="linenos"> 41</span><span class="sd">        :param outputDir: The output directory</span>
<span class="linenos"> 42</span><span class="sd">        :param properties: Transformation plugin properties. </span>
<span class="linenos"> 43</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 44</span>        <span class="n">input_path</span><span class="o">=</span><span class="n">inputDirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data_path</span>
<span class="linenos"> 45</span>        <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_transform</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">outputDir</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="k">def</span> <span class="nf">ground_truth_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputPath</span><span class="p">,</span> <span class="n">outputPath</span><span class="p">):</span>
<span class="linenos"> 48</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 49</span><span class="sd">        Perform a ground truth transform</span>
<span class="linenos"> 50</span><span class="sd">        </span>
<span class="linenos"> 51</span><span class="sd">        :param inputPath: The directory path where input files are found</span>
<span class="linenos"> 52</span><span class="sd">        :param outputPath: The directory path where the output files will be stored. </span>
<span class="linenos"> 53</span><span class="sd">        &quot;&quot;&quot;</span> 
<span class="linenos"> 54</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 55</span>            <span class="n">_</span><span class="p">,</span> <span class="n">mnist_train_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 56</span>            <span class="n">_</span><span class="p">,</span> <span class="n">mnist_test_labels</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">inputPath</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 57</span>            
<span class="linenos"> 58</span>            <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="s1">&#39;ground_truth.csv&#39;</span><span class="p">)</span>
<span class="linenos"> 59</span>            
<span class="linenos"> 60</span>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos"> 61</span>                
<span class="linenos"> 62</span>                <span class="c1"># Write the header</span>
<span class="linenos"> 63</span>                <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;id, label</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="linenos"> 64</span>                <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="linenos"> 65</span>                
<span class="linenos"> 66</span>                <span class="c1"># Process the training data</span>
<span class="linenos"> 67</span>                <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_labels</span><span class="p">))))</span>                        
<span class="linenos"> 68</span>                
<span class="linenos"> 69</span>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_labels</span><span class="p">)):</span>
<span class="linenos"> 70</span>                    <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_train_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="linenos"> 71</span>                    <span class="n">row_id</span> <span class="o">=</span> <span class="s1">&#39;mnist-train-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding_size</span><span class="p">))</span>
<span class="linenos"> 72</span>                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>                
<span class="linenos"> 73</span>                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="linenos"> 74</span>                    <span class="c1">#idx+=1</span>
<span class="linenos"> 75</span>                 
<span class="linenos"> 76</span>                <span class="c1"># Process the test data</span>
<span class="linenos"> 77</span>                <span class="n">padding_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_labels</span><span class="p">))))</span>                        
<span class="linenos"> 78</span>                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_labels</span><span class="p">)):</span>
<span class="linenos"> 79</span>                    <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_test_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="linenos"> 80</span>                    <span class="n">row_id</span> <span class="o">=</span> <span class="s1">&#39;mnist-test-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding_size</span><span class="p">))</span>
<span class="linenos"> 81</span>                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>                
<span class="linenos"> 82</span>                    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                    
<span class="linenos"> 83</span>                    
<span class="linenos"> 84</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<span class="linenos"> 85</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unexpected error caught during transform&quot;</span>
<span class="linenos"> 86</span>            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 87</span>            <span class="k">raise</span> <span class="n">ex</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">basedir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 92</span><span class="sd">    Loads the MNIST formatted dataset.</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="sd">    :param basedir: The base directory from which to load files</span>
<span class="linenos"> 95</span><span class="sd">    :param is_training: Flag indicating whether this is for training data</span>
<span class="linenos"> 96</span><span class="sd">    </span>
<span class="linenos"> 97</span><span class="sd">    :return: A tuple of Numpy arrays: `(x_train, y_train).</span>
<span class="linenos"> 98</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 99</span>    <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
<span class="linenos">100</span>        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;train-images-idx3-ubyte.gz&#39;</span><span class="p">]</span>
<span class="linenos">101</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">102</span>        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t*k-labels-idx1-ubyte.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;t*k-images-idx3-ubyte.gz&#39;</span><span class="p">]</span>
<span class="linenos">103</span>    
<span class="linenos">104</span>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading files from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">basedir</span><span class="p">)</span>
<span class="linenos">105</span>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">106</span>    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<span class="linenos">107</span>        <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>
<span class="linenos">108</span>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
<span class="linenos">109</span>            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">110</span>            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added file </span><span class="si">%s</span><span class="s2"> to load path&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
<span class="linenos">111</span>    
<span class="linenos">112</span>    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lbpath</span><span class="p">:</span>
<span class="linenos">113</span>        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">lbpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="linenos">114</span>    
<span class="linenos">115</span>    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">imgpath</span><span class="p">:</span>
<span class="linenos">116</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">imgpath</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="linenos">117</span>        
<span class="linenos">118</span>    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="evaluation-interface">
<h2>Evaluation Interface<a class="headerlink" href="#evaluation-interface" title="Permalink to this heading"></a></h2>
<p>The MISTK API provides an interface for creating evaluation plugins to evaluate models
against specific metrics. These plugins run within docker containers similar to models.
A MISTK evaluation implements the ‘mistk.evaluation.AbstractEvaluationPlugin’ abstract class.
This class provides a set of abstract methods that represent the evaluation lifecycle and
must be implemented by the new evaluation plugin. Ultimately, these methods form the core of
the web endpoint service that is made available for every evaluation implementation.</p>
<dl class="simple">
<dt><strong>do_evaluate</strong> (assessment_type: string, metrics: list, input_data_path: string, evaluation_input_format: string, ground_truth_path: string, evaluation_path: string, properties: dict)</dt><dd><p>Performs an evaluation using the ground truth data and predictions data for the assessment type and metrics
specified and stores the resulting evaluation in the output directory.</p>
<dl class="field-list simple">
<dt class="field-odd">param assessment_type<span class="colon">:</span></dt>
<dd class="field-odd"><p>The evaluation type. One of {‘BinaryClassification’,
‘MultilabelClassification’, ‘MulticlassClassification’, ‘Regression’}</p>
</dd>
<dt class="field-even">param metrics<span class="colon">:</span></dt>
<dd class="field-even"><p>Specific metrics to evaluate against instead of all metrics defined by assessment_type</p>
</dd>
<dt class="field-odd">param input_data_path<span class="colon">:</span></dt>
<dd class="field-odd"><p>Path to input data for the evaluation</p>
</dd>
<dt class="field-even">param evaluation_input_format<span class="colon">:</span></dt>
<dd class="field-even"><p>The format of the input data. One of {predictions, generations}</p>
</dd>
<dt class="field-odd">param ground_truth_path<span class="colon">:</span></dt>
<dd class="field-odd"><p>The directory path where the ground_truth.csv file is located</p>
</dd>
<dt class="field-even">param evaluation_path<span class="colon">:</span></dt>
<dd class="field-even"><p>A directory path to where the evaluation.json output file will be stored</p>
</dd>
<dt class="field-odd">param properties<span class="colon">:</span></dt>
<dd class="field-odd"><p>A dictionary of key value pairs for evaluation plugin arguments.</p>
</dd>
</dl>
</dd>
<dt><strong>do_terminate</strong> ()</dt><dd><p>Prepare for application termination.</p>
</dd>
</dl>
<section id="evaluation-metrics">
<h3>Evaluation Metrics<a class="headerlink" href="#evaluation-metrics" title="Permalink to this heading"></a></h3>
<p>Metrics are loaded for the evaluation container based on the metrics.json file. This JSON file contains a list
of Metric objects to describe the metric and how it will be executed.</p>
<p>The Metric values will require the following fields:</p>
<blockquote>
<div><p>object_info: A dictionary that stores metadata information for the
dataset. Only the ‘name’ and ‘kind’ fields are required, all other
fields are optional.</p>
<p>image_id: The image id for the evaluation container to run.</p>
<p>assessment_types: The assessment type for the metric, e.g. MulticlassClassification.</p>
</div></blockquote>
<p>An example for a metric:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;objectInfo&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Metric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sklearn.metrics.r2_score&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;imageId&quot;</span><span class="p">:</span> <span class="s2">&quot;docker-registry:5000/sml-evaluators/sklearn&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assessmentTypes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Regression&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Metric values can optionally contain the following fields for accessing external metrics from other Python packages:</p>
<blockquote>
<div><p>package: (str) The name of the package containing the implementation of this external metric.</p>
<p>method: (str) The name of the method from <cite>package</cite> to be called when executing the external metric.</p>
<p>defaultArgs: (dict) The default arguments passed to the method when the metric is called.
These key/value pairs can also be used as properties for the metric.</p>
</div></blockquote>
<p>An example for an external metric:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s2">&quot;objectInfo&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;Metric&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;r2_score&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;imageId&quot;</span><span class="p">:</span> <span class="s2">&quot;docker-registry:5000/sml-evaluators/sklearn&quot;</span><span class="p">,</span>
  <span class="s2">&quot;assessmentTypes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Regression&quot;</span><span class="p">],</span>
  <span class="s2">&quot;package&quot;</span><span class="p">:</span> <span class="s2">&quot;sklearn.metrics&quot;</span><span class="p">,</span>
  <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;r2_score&quot;</span><span class="p">,</span>
  <span class="s2">&quot;defaultArgs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;multioutput&quot;</span><span class="p">:</span> <span class="s2">&quot;uniform_average&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-evaluation-state-machine">
<h3>The Evaluation State Machine<a class="headerlink" href="#the-evaluation-state-machine" title="Permalink to this heading"></a></h3>
<p>Evaluation plugin implementations follow a workflow lifecycle based on state machine
transitions. The underlying MISTK infrastructure ensures that only legal
transitions from one state to another can be made and that the appropriate
model methods are called during those transitions. The image below illustrates
the high-level state machine transitions and the evaluation plugin methods
that may be called between them.</p>
<img alt="_images/evaluation_state_machine.png" src="_images/evaluation_state_machine.png" />
<p>A evaluation plugin instance will automatically go to the Started state if its
container instance successfully starts up. After completing a evaluation, it
will return to the Ready state so that multiple evaluations can be executed
using the same container instance.</p>
</section>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>The following example code implements a sklearn evaluation metrics with the MISTK evaluation metrics interfacet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">##############################################################################</span>
<span class="linenos">  2</span><span class="c1">#</span>
<span class="linenos">  3</span><span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  4</span><span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  5</span><span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  6</span><span class="c1">#    (at your option) any later version.</span>
<span class="linenos">  7</span><span class="c1">#</span>
<span class="linenos">  8</span><span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  9</span><span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 10</span><span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 11</span><span class="c1">#    GNU General Public License for more details.</span>
<span class="linenos"> 12</span><span class="c1">#</span>
<span class="linenos"> 13</span><span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 14</span><span class="c1">#    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 15</span><span class="c1">#</span>
<span class="linenos"> 16</span><span class="c1">##############################################################################</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="linenos"> 19</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 20</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="linenos"> 21</span><span class="kn">import</span> <span class="nn">json</span>
<span class="linenos"> 22</span><span class="kn">import</span> <span class="nn">time</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MultiLabelBinarizer</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="kn">from</span> <span class="nn">mistk.evaluation.abstract_evaluation_plugin</span> <span class="kn">import</span> <span class="n">AbstractEvaluationPlugin</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">mistk.evaluation.util.convert</span> <span class="kn">import</span> <span class="n">csv_predictions_to_dataframe</span><span class="p">,</span> <span class="n">csv_groundtruth_to_dataFrame</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">mistk</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="k">class</span> <span class="nc">SklearnEvaluation</span> <span class="p">(</span><span class="n">AbstractEvaluationPlugin</span><span class="p">):</span>
<span class="linenos"> 31</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 32</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">        Constructor</span>
<span class="linenos"> 34</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 35</span>        <span class="n">AbstractEvaluationPlugin</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 36</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 37</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 38</span>  
<span class="linenos"> 39</span>    <span class="k">def</span> <span class="nf">do_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assessment_type</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">input_data_path</span><span class="p">,</span> <span class="n">evaluation_input_format</span><span class="p">,</span> <span class="n">ground_truth_path</span><span class="p">,</span> <span class="n">evaluation_path</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
<span class="linenos"> 40</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 41</span><span class="sd">        Performs metrics&#39; evaluation using the predictions and ground truth files provided.</span>
<span class="linenos"> 42</span><span class="sd">        Stored the assessment results as a JSON file in the evaluation_path</span>
<span class="linenos"> 43</span><span class="sd">        </span>
<span class="linenos"> 44</span><span class="sd">        :param assessment_type: The evaluation assessment type. One of {&#39;BinaryClassification&#39;, </span>
<span class="linenos"> 45</span><span class="sd">            &#39;MultilabelClassification&#39;, &#39;MulticlassClassification&#39;, &#39;Regression&#39;}</span>
<span class="linenos"> 46</span><span class="sd">        :param metrics: Specific metrics to evaluate against instead of all metrics defined by assessment_type</span>
<span class="linenos"> 47</span><span class="sd">        :param input_data_path: Path to input data for the evaluation</span>
<span class="linenos"> 48</span><span class="sd">        :param evaluation_input_format: The format of the input data</span>
<span class="linenos"> 49</span><span class="sd">        :param ground_truth_path: The directory path where the ground_truth.csv file is located</span>
<span class="linenos"> 50</span><span class="sd">        :param evaluation_path: A directory path to where the evaluation.json output file will be stored</span>
<span class="linenos"> 51</span><span class="sd">        :param properties: A dictionary of key value pairs for evaluation plugin arguments. </span>
<span class="linenos"> 52</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 53</span>        <span class="k">if</span> <span class="n">evaluation_input_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;predictions&quot;</span><span class="p">:</span>
<span class="linenos"> 54</span>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;EvaluationInputFormat </span><span class="si">%s</span><span class="s2"> is not supported by this Metric Evaluator, only &#39;predictions&#39; are supported&quot;</span> <span class="o">%</span> <span class="n">evaluation_input_format</span>
<span class="linenos"> 55</span>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 56</span>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 57</span> 
<span class="linenos"> 58</span>        <span class="c1"># load prediction results</span>
<span class="linenos"> 59</span>        <span class="n">full_predictions_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_data_path</span><span class="p">,</span> <span class="s2">&quot;predictions.csv&quot;</span><span class="p">)</span>
<span class="linenos"> 60</span>        <span class="n">results_df</span> <span class="o">=</span> <span class="n">csv_predictions_to_dataframe</span><span class="p">(</span><span class="n">full_predictions_path</span><span class="p">)</span>
<span class="linenos"> 61</span>        
<span class="linenos"> 62</span>        <span class="c1"># load ground truth</span>
<span class="linenos"> 63</span>        <span class="n">full_ground_truth_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ground_truth_path</span><span class="p">,</span> <span class="s2">&quot;ground_truth.csv&quot;</span><span class="p">)</span>
<span class="linenos"> 64</span>        <span class="n">truth_df</span> <span class="o">=</span> <span class="n">csv_groundtruth_to_dataframe</span><span class="p">(</span><span class="n">full_ground_truth_path</span><span class="p">)</span>
<span class="linenos"> 65</span>        
<span class="linenos"> 66</span>        <span class="c1"># match ground truth to results by id </span>
<span class="linenos"> 67</span>        <span class="n">truth_df</span> <span class="o">=</span> <span class="n">truth_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;rowid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;rowid&#39;</span><span class="p">])]</span>
<span class="linenos"> 68</span>            
<span class="linenos"> 69</span>        <span class="c1"># sort the rows by id</span>
<span class="linenos"> 70</span>        <span class="n">results_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 71</span>        <span class="n">truth_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rowid&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 72</span>        
<span class="linenos"> 73</span>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running for metrics </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metrics</span><span class="p">)</span>
<span class="linenos"> 74</span>            
<span class="linenos"> 75</span>        <span class="k">if</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MultilabelClassification&quot;</span> <span class="ow">or</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MulticlassClassification&quot;</span><span class="p">:</span>
<span class="linenos"> 76</span>            <span class="c1"># create matrices for labels and confidence</span>
<span class="linenos"> 77</span>            <span class="n">label_mlb</span> <span class="o">=</span> <span class="n">MultiLabelBinarizer</span><span class="p">()</span>
<span class="linenos"> 78</span>            <span class="n">parsed_truth_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 79</span>                                   <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos"> 80</span>                                   <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
<span class="linenos"> 81</span>            <span class="n">parsed_results_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 82</span>                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos"> 83</span>                                     <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
<span class="linenos"> 84</span>            <span class="n">label_mlb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_truth_labels</span><span class="p">,</span> <span class="n">parsed_results_labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="linenos"> 85</span>            <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">parsed_truth_labels</span><span class="p">)</span>
<span class="linenos"> 86</span>            <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">parsed_results_labels</span><span class="p">)</span>
<span class="linenos"> 87</span>            
<span class="linenos"> 88</span>            <span class="k">if</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">results_df</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
<span class="linenos"> 89</span>                <span class="n">parsed_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 90</span>                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos"> 91</span>                                     <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
<span class="linenos"> 92</span>                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="linenos"> 93</span>                <span class="n">label_classes</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos"> 94</span>                <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_results_labels</span><span class="p">):</span>
<span class="linenos"> 95</span>                    <span class="n">confidence_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos"> 96</span>                    <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="linenos"> 97</span>                        <span class="n">label_pos</span> <span class="o">=</span> <span class="n">label_classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
<span class="linenos"> 98</span>                        <span class="n">confidence_row</span><span class="p">[</span><span class="n">label_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">parsed_confidence</span><span class="p">[</span><span class="n">row_index</span><span class="p">][</span><span class="n">col_index</span><span class="p">])</span>  <span class="c1">#pylint: disable=no-member</span>
<span class="linenos"> 99</span>                    <span class="n">confidence_matrix</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_row</span>
<span class="linenos">100</span>        <span class="k">elif</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;Regression&quot;</span><span class="p">:</span>
<span class="linenos">101</span>            <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
<span class="linenos">102</span>                <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">103</span>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">truth_labels_matrix</span><span class="p">):</span>
<span class="linenos">104</span>                    <span class="n">truth_labels_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
<span class="linenos">105</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">106</span>                <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos">107</span>                
<span class="linenos">108</span>            <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
<span class="linenos">109</span>                <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">110</span>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results_labels_matrix</span><span class="p">):</span>
<span class="linenos">111</span>                    <span class="n">results_labels_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
<span class="linenos">112</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">113</span>                <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos">114</span>                
<span class="linenos">115</span>            <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
<span class="linenos">116</span>                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">117</span>                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_matrix</span><span class="p">):</span>
<span class="linenos">118</span>                    <span class="n">confidence_matrix</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#pylint: disable=no-member</span>
<span class="linenos">119</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">120</span>                <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos">121</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">122</span>            <span class="n">truth_labels_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">123</span>                                   <span class="k">if</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos">124</span>                                   <span class="k">else</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">125</span>            <span class="n">results_labels_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
<span class="linenos">126</span>                                     <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos">127</span>                                     <span class="k">else</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">128</span>            <span class="n">confidence_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> 
<span class="linenos">129</span>                                 <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> 
<span class="linenos">130</span>                                 <span class="k">else</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="linenos">131</span>    
<span class="linenos">132</span>        <span class="n">eval_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">133</span>        <span class="n">modules_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">134</span>        
<span class="linenos">135</span>        <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
<span class="linenos">136</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span>  <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<span class="linenos">137</span>            <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modules_cache</span><span class="p">:</span>
<span class="linenos">138</span>                <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">139</span>                <span class="n">name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span>
<span class="linenos">140</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">141</span>                    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>
<span class="linenos">142</span>                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">143</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">144</span>                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception importing plugin module &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
<span class="linenos">145</span>                <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
<span class="linenos">146</span>                    <span class="n">modules_cache</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
<span class="linenos">147</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">148</span>                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot load &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
<span class="linenos">149</span>                    <span class="k">continue</span>
<span class="linenos">150</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">151</span>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading cached module&quot;</span><span class="p">)</span>
<span class="linenos">152</span>                <span class="n">module</span> <span class="o">=</span> <span class="n">modules_cache</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">]</span>
<span class="linenos">153</span>                        
<span class="linenos">154</span>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">):</span>
<span class="linenos">155</span>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot; in &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
<span class="linenos">156</span>                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
<span class="linenos">157</span>                
<span class="linenos">158</span>                <span class="n">args</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">default_args</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="linenos">159</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_labels</span><span class="p">:</span>
<span class="linenos">160</span>                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_labels</span><span class="p">]</span> <span class="o">=</span> <span class="n">truth_labels_matrix</span>
<span class="linenos">161</span>                        
<span class="linenos">162</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_bounds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
<span class="linenos">163</span>                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">truth_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="n">truth_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos">164</span>                    
<span class="linenos">165</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_labels</span><span class="p">:</span>
<span class="linenos">166</span>                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_labels</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_labels_matrix</span>
<span class="linenos">167</span>                        
<span class="linenos">168</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_scores</span> <span class="ow">and</span> <span class="s1">&#39;confidence&#39;</span> <span class="ow">in</span> <span class="n">results_df</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>           
<span class="linenos">169</span>                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_scores</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_matrix</span>
<span class="linenos">170</span>                    
<span class="linenos">171</span>                <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_bounds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span><span class="p">:</span>
<span class="linenos">172</span>                    <span class="n">args</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">data_parameters</span><span class="o">.</span><span class="n">prediction_bounds</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="linenos">173</span>                                            
<span class="linenos">174</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">175</span>                    <span class="n">evalResult</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
<span class="linenos">176</span>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="linenos">177</span>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Something bad happened calling &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">178</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">179</span>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">evalResult</span><span class="p">))</span>
<span class="linenos">180</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="linenos">181</span>                        <span class="c1"># convert to native types</span>
<span class="linenos">182</span>                        <span class="n">evalResultAsList</span> <span class="o">=</span> <span class="n">evalResult</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">183</span>                        <span class="k">if</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MultilabelClassification&quot;</span> <span class="ow">or</span> <span class="n">assessment_type</span> <span class="o">==</span> <span class="s2">&quot;MulticlassClassification&quot;</span><span class="p">:</span>
<span class="linenos">184</span>                            <span class="c1"># map labels to their values in the results</span>
<span class="linenos">185</span>                            <span class="n">label_classes</span> <span class="o">=</span> <span class="n">label_mlb</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">186</span>                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evalResultAsList</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_classes</span><span class="p">):</span>
<span class="linenos">187</span>                                <span class="n">evalResultAsDict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">188</span>                                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_classes</span><span class="p">):</span>
<span class="linenos">189</span>                                    <span class="n">evalResultAsDict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span> <span class="o">=</span> <span class="n">evalResultAsList</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="linenos">190</span>                                <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsDict</span>
<span class="linenos">191</span>                            <span class="k">else</span><span class="p">:</span>
<span class="linenos">192</span>                                <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsList</span>
<span class="linenos">193</span>                        <span class="k">else</span><span class="p">:</span>
<span class="linenos">194</span>                            <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsList</span>
<span class="linenos">195</span>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">):</span>
<span class="linenos">196</span>                        <span class="c1"># convert to native type</span>
<span class="linenos">197</span>                        <span class="n">evalResultAsScalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asscalar</span><span class="p">(</span><span class="n">evalResult</span><span class="p">)</span>
<span class="linenos">198</span>                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResultAsScalar</span>
<span class="linenos">199</span>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evalResult</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="linenos">200</span>                        <span class="c1"># kind of a cheat to cover the case where a native type has numpy elements</span>
<span class="linenos">201</span>                        <span class="c1"># which some scikit-learn methods inexplicably return</span>
<span class="linenos">202</span>                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evalResult</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="linenos">203</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">204</span>                        <span class="n">eval_dict</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">object_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evalResult</span>
<span class="linenos">205</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">206</span>                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot; does not exist in &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>  
<span class="linenos">207</span>                
<span class="linenos">208</span>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed metric &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="linenos">209</span>                
<span class="linenos">210</span>        <span class="n">eval_dict_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">eval_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 
<span class="linenos">211</span>        <span class="n">filename</span> <span class="o">=</span> <span class="n">evaluation_path</span> <span class="o">+</span> <span class="s2">&quot;/eval_results_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
<span class="linenos">212</span>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing eval results to &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span> 
<span class="linenos">213</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
<span class="linenos">214</span>            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">eval_dict_json</span><span class="p">)</span>
<span class="linenos">215</span>    
<span class="linenos">216</span>    <span class="k">def</span> <span class="nf">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">217</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">218</span><span class="sd">        Terminate the MISTK Evaluation Metric</span>
<span class="linenos">219</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">220</span>        <span class="n">AbstractEvaluationPlugin</span><span class="o">.</span><span class="n">do_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intro.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>